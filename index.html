
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Philippe Bourgau's blog</title>
  <meta name="author" content="Philippe Bourgau">

  
  <meta name="description" content="A blog around eXtreme Programming. Tips to build high performing and sustainable teams by adapting XP to their unique challenges and context.">

  
  <meta name="keywords" content="Blog, Programming, eXtreme Programming, XP, TDD, Remote, Best Practices, Tips, Tutorial">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://philippe.bourgau.net/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Philippe Bourgau's blog" type="application/atom+xml">
  <link href="/stylesheets/asides.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/banner.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/tables.css" media="screen, projection" rel="stylesheet" type="text/css" />
<link href="/stylesheets/images.css" rel="stylesheet" type="text/css">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|Istok+Web:400,400italic,700,700italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Shadows+Into+Light" rel="stylesheet" type="text/css" />

<meta name="google-translate-customization" content="799b363844424d98-0fe595ed0d0bb43c-g68c635d8080c4daa-14"></meta>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30589315-1', 'auto', {'allowLinker': true});
  ga('send', 'pageview');
  ga('require', 'linker');
  ga('linker:autoLink', ['agileavatars.com']);
</script>

<!-- tables css -->

  

</head>

<body>
  <div id="header-container">
    <div id="header">
      <div class="wrapper">
        <header role="banner"><hgroup>
  <h1><a href="/">Philippe Bourgau's blog</a></h1>
</hgroup>

</header>
        <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://eepurl.com/dxKE95" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:philippe.bourgau.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
      </div>
    </div>
  </div>
  <div id="body"   >
    <div id="main">
      <div id="content">
	<div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/principles-that-will-make-you-become-a-badass-developer/">Principles That Will Make You Become a Badass Developer</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-07-19T12:57:00+02:00" pubdate data-updated="true">Jul 19<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my <a href="/5-mistakes-badass-developers-never-do/">last post</a>, I went over things we should avoid if we want to become badass developers. As I said though, this is far from enough. Once we&rsquo;ve stoped losing trust from the business, it&rsquo;s time to build some more ! This is the forth post in <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">a series about how to get sponsorship for a large scale refactoring</a>. If you haven&rsquo;t, start reading from <a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">the beginning</a>.</p>

<p>The badass developers gain the business&rsquo;s trust by sneaking in as business partners. A good way to become one is to start acting like one ! Here are examples of principles for that.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-07-09-principles-that-will-make-you-become-a-badass-developer/badass-principles-tatoo.jpg" alt="Arm of a badass developer with the tatoo '&gt; Badass Principles;' " /></p>

<h2>Keeping the business best interests in mind</h2>

<p>This is all about decision making. We should try to steer decisions according to the business. Whenever we talk with business people, we should stay aways from technical topics. I still remember my younger self explaining threading details to a trader &hellip; Most of all I remember the look on his face ! We should avoid technical bla bla, but we should be clear about the business consequences.</p>

<h2>Honesty and Candor</h2>

<p>When we don&rsquo;t agree with something, we should say so. When we don&rsquo;t understand something, we should ask the question. We need to stick to facts and assume everyone has the business&rsquo;s best interests in mind. Candor is a way to get our opinions and questions through, without sounding rude or pushy. There&rsquo;s a whole chapter about candor in <a href="https://www.amazon.com/Creativity-Inc-Overcoming-Unseen-Inspiration/dp/0812993012/ref=sr_1_1?ie=UTF8&amp;qid=1531133278&amp;sr=8-1">Creativity.inc</a>, the book about Pixar.</p>

<p><a href="https://www.amazon.com/Creativity-Inc-Overcoming-Unseen-Inspiration/dp/0812993012/ref=sr_1_1?ie=UTF8&amp;qid=1531133278&amp;sr=8-1"><img src="http://philippe.bourgau.net/imgs/2018-07-09-principles-that-will-make-you-become-a-badass-developer/creativity-inc.jpg" alt="Cover of the Creativity.inc book. It contains lessons on Candor we should all read to become badass developers" /></a></p>

<p>With time, business people will think of us as a positive and <a href="/real-developers-ship/">pragmatic problem solvers</a>. That is exactly the kind of people they want to work with !</p>

<blockquote><p>ðŸ’¡ Candor is a way to get our opinions and questions through, without sounding rude or pushy.</p></blockquote>

<h2>Strong opinions, but weekly held</h2>

<p><a href="https://twitter.com/codinghorror">Jeff Atwood</a>, already <a href="https://blog.codinghorror.com/strong-opinions-weakly-held/">wrote</a> about this. The idea is to fight for our opinions, but let them go without a fuss when we proved wrong. We know that we are all very often wrong. Only fools or self-centered people don&rsquo;t admit this reality. Business people won&rsquo;t trust us in either case. We need to show that we can go over our previous opinions. This grows our reputation of rational problem solver.</p>

<h2>Acknowledging when we don&rsquo;t know</h2>

<p>The same logic goes with knowledge. None of us knows everything. We have to admit when we don&rsquo;t know something and ask for help. This proves that we place the business&rsquo;s speed over our personal &lsquo;know-it-all&rsquo; reputation.</p>

<p>Here is a story that happened to me at my first job. I&rsquo;m sure most developers go through it one day or another. I was assigned a new task involving technologies I did not know. I did not have the guts to state upfront that I would have to learn them. The result was that I sent 2 full weeks fiddling with this task to get something working. The more it went on, the more the product people were wondering why it was taking so long, and the more I got stressed !</p>

<h2>Be bold and say No !</h2>

<p>If we are sure something we should not do something, we need to say so. Badass developers are not afraid to say they won&rsquo;t do it. <a href="/are-software-developers-overworked-or-undecided/">Good software engineering requires merciless prioritization</a>. If there are doubt about the value of doing something, it&rsquo;s often a better idea to make sure before wasting time on it.</p>

<p>There are many ways to say &lsquo;No&rsquo;. Before giving a harsh &lsquo;No&rsquo;, we can try to challenge decisions. We can ask for clarifications and rationals through open questions. Very often, highlighting the risks makes people review their plans. As technical experts, we should also share as much of the consequences as possible.</p>

<p>In the end, badass developers are ready to leave a <a href="https://www.urbandictionary.com/define.php?term=Fubared">FUBARed</a> situation. Great engineers don&rsquo;t have troubles finding jobs these days &hellip; There&rsquo;s no reason they should accept to be waisting their time.</p>

<blockquote><p>ðŸ’¡ In the end, badass developers are ready to leave a FUBARed situation</p></blockquote>

<h2>What do to next ?</h2>

<p>As we become badass developers, our reputation will grow. We&rsquo;ll be in a better position to negotiate a large scale refactoring with the business. There&rsquo;s a catch though : we&rsquo;ll need to live up to our reputation ! Admitting that we are wrong 100% with candor will not make it !Â </p>

<p>When we manage to negotiate a large scale refactoring, the team will need to do a good job of it. This boils down to delivering it piece by piece, alongside features. This is exactly what my <a href="http://eepurl.com/dxKE95">next post</a> will be about.</p>

<p>This post was the forth post in a <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">series about how to get sponsorship for a large scale refactoring</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/5-mistakes-badass-developers-never-do/">5 Mistakes Badass Developers Never Do</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-07-12T12:51:00+02:00" pubdate data-updated="true">Jul 12<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is a one sentence summary of my <a href="/why-we-need-badass-developers-to-perform-large-scale-refactorings/">previous post</a>.</p>

<blockquote><p>Badass developers negotiate large scale refactorings with the business better.</p></blockquote>

<p> Unfortunately, not all of us are sitting next to a true badass developer &hellip; Hopefully, we can all become one ! Depending on our track record, it&rsquo;s going to be more or less difficult, but with time and the good attitude, we can all do it. Becoming a badass developer is all about trustworthiness.</p>

<p>This post is the third in a <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">series about how to get sponsorship for a large scale refactoring</a>. If you haven&rsquo;t, I recommend you to start from <a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">the beginning</a>.</p>

<p>The first thing to become trustworthy is to avoid things that kill trust. Sounds obvious, but it&rsquo;s very easy to forget. Here are 5 examples of trust killers you should never do if you want to become a badass developer.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-07-03-5-mistakes-badass-developers-never-do/mistake.jpg" alt="Drawing of a hurt finger after someone made a mistake with a hammer. Badass developer don't do this kind of mistakes !" /></p>

<h2>Resume Driven Development</h2>

<p>We should pick the best tools for the job. The best tools are often a bit old, precisely because they&rsquo;ve been battle tested in production for a while ! That&rsquo;s exactly the kind of technologies you want your business to rely on.</p>

<p>To keep his skills up to date, a badass developer will not add a funky new tech in the production code. He would rather negotiate <a href="http://www.jamesshore.com/Agile-Book/slack.html">slack time</a> with the business. He might also openly <em>take</em> his Friday afternoons to experiment the latest techs ! He would simply explain that it&rsquo;s to avoid polluting the production system.</p>

<blockquote><p>ðŸ’¡ A badass developer will not add a funky new tech in the production code.</p></blockquote>

<h2>Over-engineering</h2>

<p>Gold plating or over-engineering are similar anti-patterns. A badass developer always keeps the business&rsquo;s interest in mind. This means he knows how to balance long term design and short term features. A good rule of thumb is to keep a vision in sight, but to get there in baby steps.</p>

<h2>Build features with no agreed upon value</h2>

<p>Product managers are here to select what should and what should not be in the product. As product experts, they are the ones who know how much a feature is worth. Except (maybe) when we are building tools for others developers, they know better than us. Adding something of dubious value in the product is bad in two ways.Â </p>

<ul>
<li>First, it takes some time to build, time that we could use to build valuable features instead. Remember : <a href="/real-developers-ship/">Real developers ship</a> !</li>
<li>Second, it creates unnecessary code to maintain. In the worst case, it can <a href="/incremental-architecture-a-cure-against-architecture-astronauts/">constraint the architecture</a>. Which might eventually prevent us from adding other more valuable features afterwards.</li>
</ul>


<h2>Hide in a tunnel</h2>

<p>We should always be careful of the tunnel effect. Seeing their money vanishing with no visible output makes business people, understandably, creepy. As soon as things become too complicated, a badass developer will raise the alarm. The fact is that he has been in this kind of situation before, and knows how to recognize it. At that point, it&rsquo;s still possible to discuss the problem with everyone, and adjust the plan.</p>

<p>As an interesting side note, I was at the <a href="https://www.meetup.com/fr-FR/DDD-Paris/">Paris DDD Meetup</a> last Thursday. We had the chance to welcome <a href="https://twitter.com/ericevans0">Eric Evans</a> as a surprise guest ! When asked what were his worst mistakes, he said something along this line :</p>

<blockquote><p>ðŸ’¡ Some of my biggest mistakes were not backtracking soon enough a few times as I was drifting in quagmire. Eric Evans</p></blockquote>

<p><a href="https://www.meetup.com/fr-FR/DDD-Paris/events/248022866/"><img src="http://philippe.bourgau.net/imgs/2018-07-03-5-mistakes-badass-developers-never-do/eric-evans-ddd-paris.jpg" alt="Eric Evans, the father of DDD, a true badass developer, answering questions at the Paris DDD meetup" /></a><div class="image-credits">By <a href="https://www.grodziski.com/">JÃ©rÃ©mie Grodziski</a>, on <a href="https://www.meetup.com/fr-FR/DDD-Paris/events/248022866/">Paris DDD Meetup</a></div><br></p>

<h2>Let the team down</h2>

<p>It&rsquo;s not only about getting the business&rsquo;s trust. We must also build trust from our fellow developers. Whenever we break the build and leave, or worse, deploy and leave, that trust is gone for a long while&hellip; We should not do that !</p>

<h2>There&rsquo;s more to a badass developer</h2>

<p>I&rsquo;m done with this list of things badass developers don&rsquo;t do. Avoiding these is only the first step to become a badass developer. In <a href="/principles-that-will-make-you-become-a-badass-developer/">next post</a>, I&rsquo;ll write about what we need to do if we want to build strong trust with the business.</p>

<p>This post is the third post in a <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">series about how to get sponsorship for a large scale refactoring.</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/why-we-need-badass-developers-to-perform-large-scale-refactorings/">Why We Need Badass Developers to Perform Large Scale Refactorings</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-07-05T13:28:00+02:00" pubdate data-updated="true">Jul 5<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">My last post</a> was about the challenge for dev teams to get sponsorship for large scale refactorings. I listed two main reasons :</p>

<ol>
<li>The business doubts developers to have their interests in mind</li>
<li>They are also not aware of the cost of the current technical debt</li>
</ol>


<p>This post (and the next) will be about how to gain the business&rsquo;s trust. This is exactly where badass developers can help. Let me start with a story.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-06-27-why-we-need-badass-developers-to-perform-large-scale-refactorings/badass-dev.jpg" alt="Drawing of 2 hands of a badass developer over his keyboard, with &quot;&gt;badass&lt;&quot; tatooed on his fingers" /></p>

<p>Back in 2002, at my first job, I started to read <a href="https://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_1?ie=UTF8">Refactoring, Improving the Design of Existing code</a>. That&rsquo;s where I read about unit testing. I found it so great that I made a demo to other programmers. Being the junior dev in the team, my co-workers reaction was something between &ldquo;Meh&rdquo; and &ldquo;Maybe&rdquo;. Fortunately, a more experienced and respected developer gave it a try. A few weeks after my demo, he announced to the team that unit testing worked great on new code. This time, people showed no questioning about his opinion : he if said so, it must have been true. Even business people blessed the practice !</p>

<p><a href="https://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_1?ie=UTF8"><img src="http://philippe.bourgau.net/imgs/2018-06-27-why-we-need-badass-developers-to-perform-large-scale-refactorings/refactoring.jpg" alt="The &quot;Refactoring, improving the design of existing code&quot; cover. Badass developers know how to perform large scale refactoring" /></a></p>

<p>I had given a good live coding demo, but it was this respected developer&rsquo;s opinion that won the point. To convince business people of sponsoring a large scale refactoring, we need their trust. That&rsquo;s why we need badass developers around.</p>

<blockquote><p>ðŸ’¡ I had given a good live coding demo, but it was this respected developer&rsquo;s opinion that won the point.</p></blockquote>

<h2>What is a badass developer</h2>

<p><a href="https://commons.wikimedia.org/wiki/File:I_am_Badass_%28Unsplash%29.jpg"><img src="http://philippe.bourgau.net/imgs/2018-06-27-why-we-need-badass-developers-to-perform-large-scale-refactorings/i-am-badass.jpg" alt="Badass Developer's fist with a ring &quot;I am badass&quot;" /></a></p>

<div class="image-credits">By Brooke Lark<a href="https://unsplash.com/photos/jtvGydbUn30">CC0</a>, via Wikimedia Commons</div>


<br>


<p>Badass developers are first of all people who are credible to the business. This usually implies a track record of <a href="/real-developers-ship/">delivering features</a> and refactorings. Badass developers understand the business constraints. That&rsquo;s why they learned how to deliver <a href="/7-reasons-why-learning-refactoring-techniques-will-improve-your-life-as-a-software-engineer/">refactorings alongside features</a>. They also need to be responsible and bold enough to <a href="/are-software-developers-overworked-or-undecided/">stand ground in front of the business</a>. Finally, badass developers are able to train others.</p>

<blockquote><p>ðŸ’¡ Badass developers are first of all people who are credible to the business</p></blockquote>

<p>Unfortunately, there are not so many badass developers in the industry &hellip; <a href="/developer-are-you-losing-your-rat-race/">It has a youngster bias</a>, and tends to push experienced developers to other activities. As if 10 years of systems design was less valuable than knowing the latest language !</p>

<h2>Learn more about Badasss developers</h2>

<p>I tried to find other words before resorting to &lsquo;Badass&rsquo;. Unfortunately, I could find none that got the point so clearly. <a href="https://blog.cleancoder.com/">Uncle bob</a> calls them &lsquo;software professionals&rsquo; in <a href="https://www.amazon.com/Clean-Coder-Conduct-Professional-Programmers/dp/0137081073/ref=sr_1_1?s=books&amp;ie=UTF8">The Clean Coder</a>. Professionalism is not specific enough to me. Adam Nowak also calls them &lsquo;responsible developers&rsquo; in a <a href="https://thenextweb.com/dd/2016/03/28/how-to-be-a-responsible-developer/">blog post</a>. Â That does not convey the idea that, sometimes devs need to stand guard in front of the business.</p>

<p><a href="https://www.amazon.com/Clean-Coder-Conduct-Professional-Programmers/dp/0137081073/ref=sr_1_1?s=books&amp;ie=UTF8"><img src="http://philippe.bourgau.net/imgs/2018-06-27-why-we-need-badass-developers-to-perform-large-scale-refactorings/clean-coder.jpg" alt="The clean coder book cover. Clean coder looks like a form of badass developer" /></a></p>

<p>These concepts, though, are very close to my definition of a badass developer. Check by yourself :</p>

<ul>
<li><a href="https://thenextweb.com/dd/2016/03/28/how-to-be-a-responsible-developer/">How to be a responsible and badass developer</a> by Adam Nowak</li>
<li><a href="https://www.youtube.com/watch?v=BgPj5b6d6nk">Developer under influence</a> by Guillaume Duquesnay</li>
<li><a href="https://www.amazon.com/Clean-Coder-Conduct-Professional-Programmers/dp/0137081073/ref=sr_1_1?ie=UTF8&amp;qid=1530082880&amp;sr=8-1&amp;keywords=the+clean+coder">The clean coder</a> by <a href="https://blog.cleancoder.com/">Robert Martin</a></li>
</ul>


<h2>To be continued</h2>

<p>This was why badass developers matter to the success of large scale refactorings. This was the second post in a <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">series about how to get sponsorship for a large scale refactoring</a>. Â In the <a href="/5-mistakes-badass-developers-never-do/">next post</a>, we&rsquo;ll look at what we can do to all become Badass developers.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">How to Convince Your Business of Sponsoring a Large Scale Refactoring</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-06-28T06:14:00+02:00" pubdate data-updated="true">Jun 28<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whenever I present or suggest a good practice to dev teams, I often get the same remark. Here is how it goes :</p>

<blockquote><ul>
<li><p>That&rsquo;s a great idea and we would love to do this, but our code is in such a mess that we cannot !</p></li>
<li><p>Maybe you should start doing more refactoring then !</p></li>
<li><p>We would like to, but we don&rsquo;t have the time. We are fire fighting all the time.</p></li>
</ul>
</blockquote>

<p>It&rsquo;s a bit like the old adage of the lumberjack that is too busy to cut wood to sharpen his axe&hellip; The sad part here, is that most of the time, developers know they would be a lot faster if they could clean up their code. Unfortunately, they are usually not given the time.</p>

<h2>How do we end up in this silly situation ?</h2>

<p><a href="http://philippe.bourgau.net/imgs/2018-06-15-how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/why-are-large-scale-refactorings-not-prioritized.jpg"><img src="http://philippe.bourgau.net/imgs/2018-06-15-how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/why-are-large-scale-refactorings-not-prioritized-small.jpg" alt="Drawing of a '5 whys' mind map explaining why it is difficult to get sponsorship for a large scale refactoring" /></a></p>

<h3>Only developers see the bad code</h3>

<p>As I&rsquo;ve <a href="/the-size-of-code/">already been joking about</a>, code is invisible. Mess in the code even more so, especially to people who don&rsquo;t code. The code could look like that and no one would notice.</p>

<p><a href="https://en.wikipedia.org/wiki/Diogenes_syndrome"><img src="http://philippe.bourgau.net/imgs/2018-06-15-how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/Syllogomanie-Puteaux.jpg" alt="Inside of a kitchen from someone suffering from Diogenes syndrome" /></a></p>

<div class="image-credits">Par <a href="//commons.wikimedia.org/w/index.php?title=User:Un_Touriste&amp;action=edit&amp;redlink=1" class="new" title="User:Un Touriste (page does not exist)">Un Touriste</a> â€” <span class="int-own-work">Photographie personnelle</span>, <a href="https://creativecommons.org/licenses/by-sa/3.0" title="Creative Commons Attribution-Share Alike 3.0">CC BY-SA 3.0</a>, <a href="https://commons.wikimedia.org/w/index.php?curid=15988115">Lien</a></div>


<br>


<p>If someone put his own office in that state, he would get fired, but not for the source code. The good side is that we, developers, are safe, we can continue to wreak chaos without fear ! That&rsquo;s pretty weird when we think that this is what we ship to customers &hellip;</p>

<blockquote><p>ðŸ’¡ Is <a href="https://en.wikipedia.org/wiki/Diogenes_syndrome">Diogenes syndrome</a> for source code a recognized pathology ?</p></blockquote>

<p>Business might also not see bad code because that&rsquo;s the only thing they&rsquo;re used to ! Maybe they&rsquo;ve always been working in dysfunctional organizations that systematically create crappy code. Slow teams, late deliveries and fire fighting might be business as usual for them. From this point of view, trying to improve code is a pure waste of time and energy. The same goes for large scale refactorings.</p>

<p>The worse part of all this is that if devs don&rsquo;t have the time to keep their code clean, it will only get worse. This will reinforce the view that software delivery is slow and that there is nothing to do about it !</p>

<h3>Business has been burnt in the past !</h3>

<p>Bad experiences are another reason why business is unwilling to sponsor refactoring. Did someone sell them an unrealistic productivity boost that turned in a never-ending tunnel project ? Badly managed large scale refactorings deliver late, create no value, and a lot of bugs. At one company I worked for, business gave devs 1 full year (!) to clean up the code &hellip; We took 2 !! Meanwhile, the CEO had to dilute the stocks a bit to keep the boat afloat ! I&rsquo;d think twice before giving this kind of mandate myself.</p>

<p>Performing a large scale refactoring is not easy, and involves specific skills. These skills are about refactoring in baby steps, alongside feature delivery.</p>

<p>Usually, people acquire these skills through hard won experience &hellip; Unfortunately for us, our industry is not very nice to experienced engineers &hellip; It&rsquo;s a lot easier to hire a fresh grad who knows the latest javascript framework than a 2 decades engineer. (Who, BTW, could learn this framework in 2 weeks &hellip;) It&rsquo;s also a lot harder for the junior developer to succeed in negotiating a refactoring.</p>

<p>Again the twist of fate is that junior engineers are a lot more likely to start a submarine latest-framework.js rewrite supposed to solve all maintenance issues &hellip; which will only make things worse.</p>

<h2>Overestimate, only as last resort</h2>

<p>A quick fix is to systematically overestimate to get enough time to refactor. As any other &lsquo;submarine&rsquo; initiative, I would recommend it only in last resort, after you&rsquo;ve tried every other possible technique &hellip; and just before you quit.</p>

<p>Hiding things to the business people kills trust and hides problems. Trust and collaboration is what you need to get the business to sponsor large scale refactorings ! Plus, if ever you mess up (as submarine initiative often do) you&rsquo;ll be the only one to blame &hellip;</p>

<p>That said, &lsquo;overestimating&rsquo; so that you can write clean code is ok. It&rsquo;s not overestimating, it&rsquo;s estimating to do a good job.</p>

<blockquote><p>ðŸ’¡ We should never ask the permission to do a good job. (<a href="https://www.youtube.com/watch?v=SfWCRl75Kas">Doc Norton</a>)</p></blockquote>

<h2>To be continued</h2>

<p>You might wonder what these other techniques are ! That&rsquo;s exactly what I&rsquo;ll go through with the next posts. This was the first one in a <a href="/blog/categories/large-scale-refactoring-sponsorship-series/">series about how to get sponsorship for a large scale refactoring</a>. The series will cover topics like :</p>

<ol>
<li> <a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">How to convince your business of sponsoring a large scale refactoring</a></li>
<li><a href="/why-we-need-badass-developers-to-perform-large-scale-refactorings/">Why we need Badass developers to perform large scale refactorings</a></li>
<li><a href="/5-mistakes-badass-developers-never-do/">5 mistakes badass developers never do</a></li>
<li><a href="/principles-that-will-make-you-become-a-badass-developer/">Principles That Will Make You Become a Badass Developer</a></li>
<li>Incremental Software Development for Large Scale Refactoring</li>
<li>Techniques to refactor in parallel with features</li>
<li>Nothing convinces business people like money</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/how-to-avoid-unnecessary-meetings-a-takeaway-from-devoxx-france-2018/">How to Avoid Unnecessary Meetings (a Takeaway From Devoxx France 2018)</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-06-21T12:48:00+02:00" pubdate data-updated="true">Jun 21<span>st</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had the chance to attend <a href="https://www.devoxx.fr/">Devoxx France</a> this year in Paris. Here is the most important lesson I learned :</p>

<blockquote><p>How to avoid unnecessary meetings with asynchronous decision making</p></blockquote>

<p><a href="https://twitter.com/bdelacretaz">Bertrand Delacretaz</a>, a member of the Apache foundation. He gave a great talk about how the open source community handles decision taking. Open source developers are often all over the world, often in different timezones. Meetings are not an option for them. Still, they manage to make great decisions !</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-06-05-how-to-avoid-unnecessary-meetings-a-takeaway-from-devoxx-france-2018/decision.jpg" alt="Drawing of a decision hammer" /></p>

<p>Even if you don&rsquo;t work remotely, avoiding unnecessary meetings is always a great thing !</p>

<ol>
<li>You&rsquo;ll have more time to do productive and interesting stuff</li>
<li>You&rsquo;ll avoid interruptions and be even more productive</li>
<li>If you are an introvert, it&rsquo;s going to be easier to contribute to the decision</li>
<li>As people have more time to think through the decision, the result is usually better</li>
</ol>


<iframe width="560" height="315" src="https://www.youtube.com/embed/xkC4zjtAyRc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>


<p>For a full walkthrough, I encourage you to watch <a href="https://www.youtube.com/watch?v=xkC4zjtAyRc">the talk in full length</a>. If you don&rsquo;t speak french, an english version is available <a href="https://www.youtube.com/watch?v=lF-bjxB2Nrk&amp;t=217s">here</a>. Finally, slides are also available in <a href="https://fr.slideshare.net/bdelacretaz/prise-de-dcisions-asynchrone-devoxx-france-2018">french</a> and <a href="https://fr.slideshare.net/bdelacretaz/asynchronous-decision-making-foss-backstage-2017">english</a>.</p>

<blockquote><p>ðŸ’¡ Even if you don&rsquo;t work remotely, avoiding unnecessary meetings is always a great thing !</p></blockquote>

<h2>Crash course</h2>

<p>For the hasty folks among you, here is a summary. The decision making follows 4 stages :</p>

<ol>
<li>Open discussion and brainstorming. People discuss openly and suggest ideas in a free form manner.</li>
<li>Emergence of options. After enough discussion, a few options will start to make more sense than others.</li>
<li>Coming to a consensus. Someone will draft a formal proposal. People will discuss and amend this proposal until they reach consensus. <a href="http://www.dictionary.com/browse/consensus">Consensus</a> is not <a href="http://www.dictionary.com/browse/unanimous">unanimity</a> !</li>
<li>Decision. After consensus, the benevolent decision owner validates the decision once and for all.</li>
</ol>


<p>Until the decision is taken, the process can move forward but also backward.</p>

<h2>Tooling</h2>

<p>We need only two tools to make this possible :</p>

<ol>
<li>For discussion, brainstorming and emergence of options, use a very open and chatty tool. The speaker called this a &ldquo;shared asynchronous communication channel&rdquo;. This can be an online chat, a mailing list or Github issues (<a href="https://github.com/apache/cordova-discuss/issues">ex</a>). It could even be a real life whiteboard if you all had access to it.</li>
<li>From drafting the proposal to the end, prefer a structured and chronological tool. The speaker suggests using a &ldquo;shared case management tool&rdquo;. Draft the proposal in this tool, and use comments to log the latest steps of the decision taking. He had examples using Jira issues (<a href="https://issues.apache.org/jira/browse/SLING-7231">ex</a>) or Github pull requests (<a href="https://github.com/apache/cordova-discuss/pulls">ex</a>). To confirm the decision, close the case. The tool will record which version of the decision was exactly taken.</li>
</ol>


<h2>Architecture Decision Record</h2>

<p><img src="http://philippe.bourgau.net/imgs/2018-06-05-how-to-avoid-unnecessary-meetings-a-takeaway-from-devoxx-france-2018/adr.jpg" alt="Drawing of an Architecture Decision Record which work great with asynchronous decision making" /></p>

<p><a href="http://thinkrelevance.com/blog/2011/11/15/documenting-architecture-decisions">ADR</a> is the practice of documenting architecture decisions. It makes sure we remember why we took a decision. This can be very useful to know how to deal with the existing software. A widespread practice for ADRs is to use simple text files in git. There are even <a href="https://github.com/npryce/adr-tools">tools for that</a>. This looks like a perfect fit for decision making using git pull requests ! I&rsquo;ll write a post about that when I get the chance to try.</p>

<blockquote><p>ðŸ’¡ Git pull requests based asynchronous decision making is a perfect fit for Architecture Decision Records.</p></blockquote>

<h2>Currently experimenting</h2>

<p>I am currently trying this whole decision making technique at work. We are still in the brainstorming phase. We are using our internal chat app for that. Options are starting to emerge, but we did not move to the consensus part yet. I&rsquo;ll write a return on experience post when we reach the end.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/a-coding-dojo-exercises-plan-towards-refactoring-legacy-code/">A Coding Dojo Exercises Plan Towards Refactoring Legacy Code</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-06-14T06:29:00+02:00" pubdate data-updated="true">Jun 14<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My current job <a href="http://www.murex.com">at work</a> is technical coach. I&rsquo;m available for teams that need help to adopt incremental coding practices.</p>

<h2>Problems with refactoring legacy code</h2>

<p>A few months ago, a team which was struggling with a lot of legacy code asked for help. As you might know if you read my blog, I&rsquo;m a big fan of <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development (TDD)</a> because it has made my <a href="http://philippe.bourgau.net/from-apprentice-to-master-how-to-learn-tdd-test-driven-development/">life as a developer so much more easy</a>. I&rsquo;m so used to TDD now, that even if I don&rsquo;t have tests yet (as is the case when refactoring legacy code), TDD helps me :</p>

<ul>
<li>To stick to baby steps which are a lot less likely to fail than larges changes.</li>
<li>Write testable code. I know what testable code looks like, and when refactoring, I&rsquo;ll try to change it towards that.</li>
</ul>


<p>That&rsquo;s why we started to run regular, all team, <a href="http://philippe.bourgau.net/blog/categories/team-randori-series/">coding dojo randoris</a>. It was nice for the <a href="http://philippe.bourgau.net/why-you-should-start-a-team-coding-dojo-randori-right-now/">team dynamics</a>, and the people where learning a lot of technical skills. I also got the feedback that they where not able to apply this directly on their day to day job though. After a bit more discussion, I understood that they did not know where this was going, what to expect, and when !</p>

<blockquote><p>ðŸ’¡ Test Driven Development also teaches you what testable code looks like.</p></blockquote>

<h2>The coding dojo exercices</h2>

<p>It turned out that a coding dojo exercises plan was enough to answer their questions. This is what it looks like.</p>

<h3>Drawing</h3>

<p><a href="http://philippe.bourgau.net/imgs/2018-06-04-a-coding-dojo-exercises-plan-towards-refactoring-legacy-code/Coding-Dojo-Hulk.jpg"><img src="http://philippe.bourgau.net/imgs/2018-06-04-a-coding-dojo-exercises-plan-towards-refactoring-legacy-code/Coding-Dojo-Hulk-small.jpg" alt="An illustrated Coding Dojo Exercises plan leading to the mastery of Legacy Code Refactoring" /></a></p>

<h3>Mind Map</h3>

<p>Here is another, more concrete, version, with sample names of katas we can find online.</p>

<p><a href="http://philippe.bourgau.net/imgs/2018-06-04-a-coding-dojo-exercises-plan-towards-refactoring-legacy-code/TDD_Kata_Plan.jpg"><img src="http://philippe.bourgau.net/imgs/2018-06-04-a-coding-dojo-exercises-plan-towards-refactoring-legacy-code/TDD_Kata_Plan-small.jpg" alt="An mind map of Coding Dojo Exercises plan leading to the mastery of Legacy Code Refactoring" /></a></p>

<h3>Text</h3>

<p>It starts with simple greenfield katas :</p>

<ul>
<li><a href="http://codingdojo.org/kata/FizzBuzz/">Fizz Buzz</a></li>
<li><a href="http://codingdojo.org/kata/RomanNumerals/">Roman Numerals</a></li>
<li><a href="http://codingdojo.org/kata/Bowling/">Bowling</a></li>
</ul>


<p>It goes on to intermediate katas, where we can use TDD to do design :</p>

<ul>
<li><a href="http://kata-log.rocks/mars-rover-kata">Mars Rover</a></li>
<li><a href="http://codingdojo.org/kata/PokerHands/">Poker Hands</a></li>
<li><a href="http://codingdojo.org/kata/TradingCardGame/">trading card game</a></li>
</ul>


<p>From then on, it&rsquo;s possible to tackle advanced katas and styles :</p>

<ul>
<li>Refactoring fresh code

<ul>
<li>Continue design katas on 2 or more sessions</li>
<li>Always compile Constraint</li>
</ul>
</li>
<li>Bottom-up TDD

<ul>
<li><a href="http://codingdojo.org/kata/GameOfLife/">Game of Life</a></li>
<li>Median of a list of lists (with no concatenation)</li>
<li><a href="http://codingdojo.org/kata/LangtonAnt/">Langton ant</a></li>
</ul>
</li>
<li>Top-Down TDD

<ul>
<li><a href="http://codingdojo.org/kata/Potter/">Kata Potter</a></li>
<li><a href="http://codingdojo.org/kata/NumberToLCD/">LCD</a></li>
</ul>
</li>
<li>TDD on algorithms

<ul>
<li><a href="http://codingdojo.org/kata/Diamond/">Diamond</a></li>
<li><a href="http://codingdojo.org/kata/Lags/">Kata Lags</a></li>
<li><a href="http://codingdojo.org/kata/Anagram/">anagrams</a></li>
</ul>
</li>
</ul>


<p>All this opens the gate to legacy code refactoring katas :</p>

<ul>
<li><a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose</a></li>
<li><a href="https://github.com/emilybache/Racing-Car-Katas">Race Car Katas</a></li>
<li><a href="https://github.com/jbrains/trivia">Ugly trivia game</a></li>
<li>Others from <a href="http://kata-log.rocks">http://kata-log.rocks</a></li>
</ul>


<p>At that point, the team can <a href="https://en.wikipedia.org/wiki/Mob_programming">mob</a> to refactor production code :</p>

<ul>
<li>Real life, static analysis issue, mob programming session</li>
<li>Real life, code smell, mob programming session</li>
<li>Real life, larger mob Refactoring</li>
</ul>


<h2>What changed in practice ?</h2>

<p>We wanted to split the teamwork and the coding dojos exercises. The team is now doing mob programming sessions on their usual stories twice a week (I&rsquo;ll blog about that someday). But also doing regular coding dojos exercises in pairs.</p>

<p>Even if they did not go through all the TDD katas yet, mobbing on real stories helps the team to take on legacy code.</p>

<blockquote><p>Given enough eyeballs, all bugs are shallow. Linus&rsquo;s Law</p></blockquote>

<p>Working in pairs on the code katas allows them to be more engaged in the exercises. In the end, it brings faster learning.</p>

<blockquote><p>ðŸ’¡ A mix of Coding Dojos in pairs and Mob Programming sessions is a good way to teach TDD in a Legacy Code context.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/when-is-testing-using-mocks-still-a-good-idea/">When Is Testing Using Mocks Still a Good Idea ?</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-06-07T06:29:00+02:00" pubdate data-updated="true">Jun 7<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the previous 7 articles of <a href="/blog/categories/how-to-avoid-mocks-series/">this series</a>, I&rsquo;ve tried my best get rid of mocks. I&rsquo;m pretty sure that using these techniques will get you a long way out of <a href="/careless-mocking-considered-harmful/">mock hell</a>. Excessive mocking leads to unmaintainable tests. Unmaintainable tests lead to low coverage. Low coverage ultimately leads to legacy code. If you haven&rsquo;t already, I encourage you to start reading from <a href="/careless-mocking-considered-harmful/">the beginning</a>.</p>

<p>One question remains though : Is it realistic to get rid of <em>all</em> mocks ? An even better question would be : Are mocks always bad ? Are there situations when mocking is the best choice ?</p>

<h2>When mocking still makes sense</h2>

<p>Let&rsquo;s to through a few examples.</p>

<h3>Testing a generic wrapper</h3>

<p>A few years ago, I had to write a service for an enterprise system. As any service, I had to ensure that it was returning nice errors. We decided to capture and wrap all errors from a few &lsquo;gate&rsquo; points in the code. We built a generic wrapper that did only delegation plus exception wrapping. In this case, it made a lot more sense to test this with a mocking framework.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="no">ServiceErrorWrapper</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">specify</span> <span class="s1">&#39;converts all kinds of exceptions&#39;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">failing_object</span> <span class="o">=</span> <span class="n">object_double</span><span class="p">(</span><span class="s2">&quot;Failing object&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">allow</span><span class="p">(</span><span class="n">failing_object</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:long_computation</span><span class="p">)</span><span class="o">.</span><span class="n">and_raise</span><span class="p">(</span><span class="no">Exception</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Something terrible happened&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">{</span> <span class="no">ServiceErrorWrapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">failing_object</span><span class="p">)</span><span class="o">.</span><span class="n">long_computation</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ServiceError</span><span class="p">)</span><span class="o">.</span><span class="n">with_message</span><span class="p">(</span><span class="s2">&quot;Something terrible happened&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not only did we reuse the wrapper many times in my service. We also ended up using it in other services as well !</p>

<h3>Injecting a hand written in-memory fake</h3>

<p>As you might have noticed, in <a href="/get-rid-of-mocking-maintenance-with-full-fledged-in-memory-fakes/">the previous article</a>, I recommended to use an in-memory fake instead of mocks. By nature, an in-memory fake is a kind of mock. Even if it is not defined by a mocking framework. (I actually think that by making mocking so easy, mocking frameworks often do more harm than good.)</p>

<blockquote><p>ðŸ’¡ By making mocking so easy, mocking frameworks often do more harm than good.</p></blockquote>

<p>Still, I used <code>const_stub(...)</code> to inject the in-memory fake.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="err">Â </span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â </span><span class="n">stub_const</span><span class="p">(</span><span class="s2">&quot;TwitterClient::Client&quot;</span><span class="p">,</span> <span class="no">FakeTwitterClient</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="err">Â </span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span> <span class="err">Â </span>
</span></code></pre></td></tr></table></div></figure>


<p>I did this for 2 reasons :</p>

<ul>
<li>Production code can continue to use a straightforward constant</li>
<li>I don&rsquo;t risk forgetting to remove the mock at the end of its lifecycle, the framework does this for me</li>
<li>As I&rsquo;m injecting the same fake for all tests, there is not much risk of test conflict (for the moment)</li>
</ul>


<h3>Testing a cache</h3>

<p>The &ldquo;raison d&#8217;Ãªtre&rdquo; of a cache is to avoid doing something twice. It should also return the same results as if it was not there. This is by nature almost impossible to test with state based assertions. Mock frameworks are great for this situation though. Here is an example :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s2">&quot;UsersController&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">it</span> <span class="s1">&#39;caches users&#39;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:load</span><span class="p">)</span><span class="o">.</span><span class="n">once</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Joe&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">controller</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">controller</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The assertion could not be more explicit, we are checking that the expensive load was only done once.</p>

<h3>Legacy code</h3>

<p><a href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052"><img src="http://philippe.bourgau.net/imgs/2018-06-01-when-is-testing-using-mocks-still-a-good-idea/legacy-code.jpg" alt="Michael C.Feathers explains that testing using mocks is a key practice in &quot;Working Effectively with Legacy Code&quot;" /></a></p>

<p>In <a href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052">Working Effectively with Legacy Code</a> <a href="https://michaelfeathers.silvrback.com/">Michael Feathers</a> explains how to exploit <a href="http://www.informit.com/articles/article.aspx?p=359417&amp;seqNum=2">&ldquo;seams&rdquo;</a> in the code to put it under test. Mocking is straightforward way to inject behavior through a seam.</p>

<p>Mocking is a pretty good starting point but we need to be careful and keep a few things in mind. Legacy or not, we must not forget that too many mocks will make tests unmaintainable !</p>

<ul>
<li>It&rsquo;s a good idea to refer to a target design or architecture blueprint to know where to inject mocks. (I&rsquo;ll write a post about this one day). This increases the chances to replace them with an in-memory fake later down the road.</li>
<li>Plan to replace the mocks with a better design as soon as possible.</li>
</ul>


<h3>It depends &hellip;</h3>

<p>As with anything in software, there is no absolute rule about mocking. Even if I prefer not to 99% of the time, there are situation when testing using mocks is the thing to do. Knowing the risks, it&rsquo;s up to you to decide !</p>

<h2>If using a mock, prefer spy / proxies</h2>

<p><img src="http://philippe.bourgau.net/imgs/2018-06-01-when-is-testing-using-mocks-still-a-good-idea/proxy-plug.jpg" alt="Spies and proxies make testing using mocks less intrusive" /></p>

<p>As I explained in previous posts, mocks duplicate behavior. If we could use mocks without duplicating behavior, they would do less harm.</p>

<p>It turns out there is a flavor of mocks for that : <a href="https://martinfowler.com/articles/mocksArentStubs.html">spies</a> and <a href="https://relishapp.com/rspec/rspec-mocks/docs/configuring-responses/calling-the-original-implementation">overlooked proxies</a>. Proxies do the real thing but also record the calls and return values. It&rsquo;s as non-intrusive as mocks can be.</p>

<blockquote><p>ðŸ’¡ Proxy mocks are as unintrusive as mocks can be.</p></blockquote>

<p>For example, here is how our cache test would look like using a proxy :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s2">&quot;UsersController&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">it</span> <span class="s1">&#39;caches users&#39;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">allow</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:load</span><span class="p">)</span><span class="o">.</span><span class="n">and_call_original</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">controller</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">controller</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:load</span><span class="p">)</span><span class="o">.</span><span class="n">once</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s more verbose, but simpler. Most mock frameworks provide some form of spy or proxies. A few years ago, I also wrote <a href="http://philou.github.io/rspecproxies">rspecproxies</a>, a wrapper on top of <a href="http://rspec.info/">rspec</a> to make this easier.</p>

<h2>This is the end</h2>

<p>This was the 8th and last post in a series about how to avoid mocks. Before closing here is a list of other references about the topic.</p>

<ul>
<li>In the <a href="https://www.youtube.com/watch?v=9LfmrkyP81M">RailsConf 2014 keynote</a>, <a href="https://twitter.com/dhh">DHH </a> explains how mocking made their test harness unreliable.</li>
<li><a href="https://martinfowler.com/articles/is-tdd-dead/">Is TDD dead</a> is a well known online discussion about the Classic vs Mockist TDD approach</li>
<li>Have a look at what <a href="https://blog.cleancoder.com/">Uncle Bob</a> says about <a href="http://blog.cleancoder.com/uncle-bob/2014/05/10/WhenToMock.html">When To Mock</a></li>
<li>For JS expert <a href="https://medium.com/@_ericelliott">Eric Elliott</a>, <a href="https://medium.com/javascript-scene/mocking-is-a-code-smell-944a70c90a6a">Mocking is a Code Smell</a></li>
<li>In this talk  <a href="https://skillsmatter.com/skillscasts/9971-testable-software-architecture-with-aslak-hellesoy">Testable Architecture talk</a>, <a href="https://twitter.com/aslak_hellesoy">Aslak HellesÃ¸y</a> explains how to build a full architecture for fast tests</li>
<li><a href="http://www.jamesshore.com/">James Shore</a> recently published a full pattern language entitled <a href="http://www.jamesshore.com/Blog/Testing-Without-Mocks.html">Testing Without Mock</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/get-rid-of-mocking-maintenance-with-full-fledged-in-memory-fakes/">Get Rid of Mock Maintenance With Full Fledged In-memory Fakes</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-05-31T19:15:00+02:00" pubdate data-updated="true">May 31<span>st</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/avoid-mocks-and-test-your-core-domain-faster-with-hexagonal-architecture/">Last week&rsquo;s post</a> was about how <a href="http://alistair.cockburn.us/Hexagonal+architecture">hexagonal architecture</a> results in fast, mock-free tests around your core domain. Unfortunately, that does not remove all mocks, yet it groups them in the same, less critical, zone. In last week&rsquo;s code sample, this was the controller. I concluded that at least, this was easier to manage. Let&rsquo;s see how.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-05-28-get-rid-of-mocking-maintenance-with-full-fledged-in-memory-fakes/in-memory-fake.jpg" alt="Hand written 'In-memory fake' with memory replaced by a RAM board" /></p>

<p>This is the 7th post in <a href="/blog/categories/how-to-avoid-mocks-series/">a series about avoiding mocks</a>. If you haven&rsquo;t, you might start from <a href="/careless-mocking-considered-harmful/">the beginning</a>.</p>

<h2>Mock concentration</h2>

<p>Let&rsquo;s get back to the <a href="/avoid-mocks-and-test-your-core-domain-faster-with-hexagonal-architecture/">last post</a>&rsquo;s code sample. As a reminder, it&rsquo;s a very basic TODO app built on <a href="https://rubyonrails.org/">Rails</a>. I extracted the domain part, the tasks, in a core domain area. This allowed to push all mocks out of this section. A consequence though, is that all mocks gathered in the controller test. Here is the controller code :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;core/task&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;infrastructure/task_repo&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'><span class="err">Â </span><span class="n">before_action</span> <span class="ss">:set_task</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># GET /tasks  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tasks</span> <span class="o">=</span> <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># GET /tasks/1  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># GET /tasks/new  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">new</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@task</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># GET /tasks/1/edit  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># POST /tasks  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">create</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">begin</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="vi">@task</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">redirect_to</span> <span class="n">task_url</span><span class="p">(</span><span class="vi">@task</span><span class="o">.</span><span class="n">db_id</span><span class="p">),</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully created.&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">rescue</span> <span class="no">ArgumentError</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">render</span> <span class="ss">:new</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># PATCH/PUT /tasks/1  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">update</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">begin</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="vi">@task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">redirect_to</span> <span class="n">task_url</span><span class="p">(</span><span class="vi">@task</span><span class="o">.</span><span class="n">db_id</span><span class="p">),</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully updated.&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">rescue</span> <span class="no">ArgumentError</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">render</span> <span class="ss">:edit</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="c1"># DELETE /tasks/1  </span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">redirect_to</span> <span class="n">tasks_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully destroyed.&#39;</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="kp">private</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">def</span> <span class="nf">set_task</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="vi">@task</span> <span class="o">=</span> <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="vi">@task</span><span class="o">.</span><span class="n">notify_when_done</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="c1"># Never trust parameters from the scary internet, only allow the white list through.  </span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">def</span> <span class="nf">task_params</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">params</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:done</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The controller is now dealing both with the Twitter connection and the database. This is visible in the controller test :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">TasksController</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:controller</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">allow</span><span class="p">(</span><span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â </span><span class="c1"># ...  </span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">describe</span> <span class="s2">&quot;PUT #update&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">context</span> <span class="s2">&quot;with valid params&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">let</span><span class="p">(</span><span class="ss">:new_attributes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="p">{</span><span class="ss">done</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">it</span> <span class="s2">&quot;updates the requested task&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="n">new_attributes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">to_param</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">task</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_done</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">it</span> <span class="s2">&quot;tweets about completed tasks&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="n">it</span> <span class="s2">&quot;redirects to the task&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="n">valid_attributes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">to_param</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â Â Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">task_url</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="c1"># ...Â </span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to <a href="https://blog.pragmatists.com/test-doubles-fakes-mocks-and-stubs-1a7491dfa3da">stub out</a> the twitter API for most tests. We are also still using a mock to verify that the tweet is sent. Finally, as we can see from the test execution times, we are still using the database in some tests.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-05-28-get-rid-of-mocking-maintenance-with-full-fledged-in-memory-fakes/test-timings.jpg" alt="Screen capture of the tests execution time" /></p>

<p>If the project grew large this would become an issue. Sadly, mocking is often the fix people jump on &hellip;</p>

<blockquote><p>ðŸ’¡ Mocking is the unfortunate quick fix to slow tests.</p></blockquote>

<p>From a mocking point of view, our current controller test can seem worse than before ! There&rsquo;s something pretty effective we can do though !</p>

<h2>In memory fakes</h2>

<p>Instead of stubbing and mocking in every test, let&rsquo;s write a full fledged in-memory <a href="https://blog.pragmatists.com/test-doubles-fakes-mocks-and-stubs-1a7491dfa3da">fake</a> that does the job we need. We could then install it once and for all, and forget about it !</p>

<p>Actually, this is nothing new. This is exactly what Rails provides out of the box with <code>ActionMailer::Base.delivery_method = :test</code>.</p>

<p>Here&rsquo;s how we could do the same thing for our Twitter Client.</p>

<h6>spec/rails_helper.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FakeTwitterClient</span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tweets</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="kp">attr_accessor</span> <span class="ss">:tweets</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tweets</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â </span><span class="c1"># ...  </span>
</span><span class='line'><span class="err">Â </span><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">stub_const</span><span class="p">(</span><span class="s2">&quot;TwitterClient::Client&quot;</span><span class="p">,</span> <span class="no">FakeTwitterClient</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h6>spec/controllers/tasks_controller_spec.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;tweets about completed tasks&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create!</span> <span class="n">valid_attributes</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">to_param</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">expect</span><span class="p">(</span><span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">tweets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple isn&rsquo;t it ?</p>

<h2>Wait a sec &hellip;</h2>

<p>There&rsquo;s a catch though &hellip; How do we make sure that this fake is behaving the same way as the real thing ?</p>

<p>Let&rsquo;s run the same tests on both ! We could mimic the twitter API in our fake, but that might not be a great idea. Do you remember the moto &ldquo;Always wrap your 3rd parties&rdquo; ? It takes all its meaning here, for 2 reasons.</p>

<p>The first is to make faking easier. We can build a minimal wrapper API that is just enough for our use. By keeping this interface small, we&rsquo;ll make it a lot easier to fake.</p>

<p>The second reason is that we can write real integration tests on the 3rd party through this wrapper. They&rsquo;d look like ordinary unit tests, except that they&rsquo;d end up calling the real 3rd party in a sandbox. They are usually pretty slow, but as 3rd parties don&rsquo;t change everyday, that&rsquo;s ok. We can ensure up-front that integration will go well. As a bonus, we can be very fast to detect and contain changes to online services. (I&rsquo;m looking at you <a href="https://en.wikipedia.org/wiki/Web_scraping">Scrappers</a>!)</p>

<p>Here is what it would look like for our Twitter client :</p>

<h6>lib/infrastructure/twitter_client.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FakeTwitterClient</span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tweets</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="kp">attr_accessor</span> <span class="ss">:tweets</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">tweet</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tweets</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">search_tweets</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@tweets</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">tweet</span><span class="o">|</span> <span class="n">tweet</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">RealTwitterClient</span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@client</span> <span class="o">=</span> <span class="ss">Twitter</span><span class="p">:</span><span class="ss">:REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">tweet</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">search_tweets</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;from:test_user </span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, we renamed <code>update</code> to <code>tweet</code> in the wrapper. We&rsquo;d have to update the calls accordingly. Let&rsquo;s look at the tests.</p>

<h6>spec/lib/Infrastructure/twitter_client_spec.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;infrastructure/twitter_client&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;securerandom&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">shared_examples</span> <span class="s2">&quot;a twitter client&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">new_client_instance</span><span class="o">|</span>
</span><span class='line'><span class="err">Â </span><span class="n">let</span><span class="p">(</span><span class="ss">:client</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_client_instance</span> <span class="p">}</span>
</span><span class='line'><span class="err">Â </span><span class="n">it</span> <span class="s2">&quot;sends tweets&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">uuid</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Philippe was here </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">client</span><span class="o">.</span><span class="n">tweet</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">search_tweets</span><span class="p">(</span><span class="n">token</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span> <span class="no">FakeTwitterClient</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">it_behaves_like</span> <span class="s2">&quot;a twitter client&quot;</span><span class="p">,</span> <span class="no">FakeTwitterClient</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span> <span class="no">RealTwitterClient</span><span class="p">,</span> <span class="ss">integration</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">speed</span><span class="p">:</span> <span class="ss">:slow</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">it_behaves_like</span> <span class="s2">&quot;a twitter client&quot;</span><span class="p">,</span> <span class="p">(</span><span class="no">RealTwitterClient</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span> <span class="err">Â Â Â Â Â Â Â </span><span class="o">=</span> <span class="s2">&quot;TEST_CONSUMER_KEY&quot;</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="err">Â Â Â Â </span><span class="o">=</span> <span class="s2">&quot;TEST_CONSUMER_SECRET&quot;</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">config</span><span class="o">.</span><span class="n">access_token</span> <span class="err">Â Â Â Â Â Â Â </span><span class="o">=</span> <span class="s2">&quot;TEST_ACCESS_TOKEN&quot;</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="s2">&quot;TEST_ACCESS_SECRET&quot;</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We had to add a search method to our interface for the sake of testing. This should remain &ldquo;For testing only&rdquo;. We&rsquo;d also adapt the controller test to use this <code>search_tweets</code> method.</p>

<p>Let&rsquo;s look at where we stand now. We&rsquo;re injecting each mock only once. Tests are fast yet straightforward, almost as if they were testing the real thing. Doing so, we&rsquo;ve split our system in cohesive parts and we&rsquo;ve wrapped our 3rd parties. We&rsquo;ve actually done a lot more than removing mocks ! <a href="https://medium.com/javascript-scene/mocking-is-a-code-smell-944a70c90a6a">Mocking really is a design smell</a>.</p>

<blockquote><p>ðŸ’¡ Merciless mock hunting will improve the design of your system !</p></blockquote>

<h2>Last word about implementation</h2>

<p>Sometimes, this 3rd party wrapper can become pretty complicated. Try to reuse as much of it as possible between the real and the fake. For example, an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a>, like ActiveRecord for example, is a wrapper around the database. Reimplementing a fake ORM would be real challenge. We&rsquo;re far better <a href="http://philippe.bourgau.net/5-minutes-hack-to-speed-up-rspec-in-rails-5-using-in-memory-sqlite/">plugin it on top of SQLite</a> instead !</p>

<h2>References</h2>

<p>Smart people have already spoken and written about this subject. If you want to learn more, I recommend that you have a look at <a href="https://twitter.com/aslak_hellesoy">Aslak HellesÃ¸y</a>&rsquo;s <a href="https://skillsmatter.com/skillscasts/9971-testable-software-architecture-with-aslak-hellesoy">Testable Architecture talk</a>. <a href="http://www.jamesshore.com/">James Shore</a>, the author of <a href="https://www.amazon.com/Art-Agile-Development-Pragmatic-Software/dp/0596527675/ref=sr_1_1?ie=UTF8&amp;qid=1527568833&amp;sr=8-1&amp;keywords=the+art+of+agile+development">The Art of Agile Development</a>, also wrote a pattern language called <a href="http://www.jamesshore.com/Blog/Testing-Without-Mocks.html">Testing Without Mock</a>.</p>

<h2>Next week</h2>

<p>This was the 7th blog post in <a href="http://philippe.bourgau.net/blog/categories/how-to-avoid-mocks-series/">a series about how to avoid mocks</a>. Hopefully, I&rsquo;m reaching the end ! <a href="/when-is-testing-using-mocks-still-a-good-idea/">Next week&rsquo;s post</a> should be the last in series, and deal with a few remaining points. What to do when you really need a mock ? What about mocking and legacy code ?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/avoid-mocks-and-test-your-core-domain-faster-with-hexagonal-architecture/">Avoid Mocks and Test Your Core Domain Faster With Hexagonal Architecture</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-05-24T06:43:00+02:00" pubdate data-updated="true">May 24<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I&rsquo;ve written in my last few posts, we can get a long way to avoid mocks with small scale coding best practices. Unfortunately, when systems reach a certain size, we need something at architecture scale.</p>

<p>This is the 6th post of a <a href="/blog/categories/how-to-avoid-mocks-series/">series about avoiding mocks</a>. If you haven&rsquo;t, you can start by <a href="/careless-mocking-considered-harmful/">the beginning</a>.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-05-24-avoid-mocks-and-test-your-core-domain-faster-with-hexagonal-architecture/hexagonal-building.jpg" alt="A drawing of a hexagon-shaped building" /></p>

<h2>Why do we end up with mocks in large systems ?</h2>

<p>A few years ago, I joined a team working in a legacy system. We wanted to apply <a href="https://en.wikipedia.org/wiki/Test-driven_development">TDD</a> and refactoring. As expected, adding tests legacy code proved a real challenge. With a lot of effort we could manage to add a few. Unfortunately, this did not seem to have any positive effect on our maintainability ! The tests we were writing all involved a lot of mocking. The system was such a large mass of spaghetti code that there was no clear place to mock. We were actually mocking where it seemed the easiest on a test by test basis. We were making progress at small scale, but the big picture was not improving at all !</p>

<p>Large systems are beasts with many faces. They Â involve a lot of IOs. They write and read data from the disk and databases. They call 3rd parties and remote services.</p>

<p>As we test these large systems, we&rsquo;ll need to stub out these IOs. Even if the tests are fast enough, we usually don&rsquo;t want to call external services for real. Most of the time though, tests are slow. That&rsquo;s 2 reasons why end up adding some mocks.</p>

<p>Here comes the nasty part. These large systems are so complex that we, developers, don&rsquo;t have the full picture. When we test, we tend to mock at different places, depending on our knowledge. This is bad for maintenance. Mocks duplicate production code behavior. When many different mocks are in place to isolate an external dependency, we end up with &lsquo;n&rsquo; versions of the code. That&rsquo;s a nightmare to refactor !</p>

<blockquote><p>ðŸ’¡ When many different mocks are in place to isolate an external dependency, we end up with &lsquo;n&rsquo; versions of the code !</p></blockquote>

<h2>Hexagonal architecture to the rescue</h2>

<p><a href="http://alistair.cockburn.us/Hexagonal+architecture">Alistair Cockburn</a> coined the term. The idea is pretty simple : Â isolate a piece of code from all dependencies. This is particularly useful for the core functional areas. With this in place, it becomes straightforward (and fast) to test the core domain logic.</p>

<p>To main techniques to isolate a piece of code from any dependency areÂ :</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency injection</a></li>
<li><a href="https://en.wikipedia.org/wiki/Observer_pattern">Observers</a></li>
<li><a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapters</a></li>
</ul>


<p>It&rsquo;s also possible to split a system in many &lsquo;hexagons&rsquo; and glue them together with adapters at startup. If you want to learn more on this style of architecture, have a look into the <a href="https://www.infoq.com/articles/ddd-contextmapping">Domain Driven Design lore</a>. This community has been building systems this way for years now.</p>

<h2>Enough talk, show me the code !</h2>

<p>This post was the occasion to try to inject a Hexagonal Architecture and a dash of DDD in a Rails application. There&rsquo;s one caveat though : DDD shines on complex systems. Unfortunately, large and complex systems make very poor didactic examples. The following code highlights the gains about mocking. We would not use DDD for such a small app in real life.</p>

<h3>The starting point</h3>

<p>I chose a simple TODO app. I started by generating a scaffold for a Task with a description and a done/not-done status. As third party interaction, completing a task sends an automatic tweet. Here is the only specific code I wrote on top of the Rails scaffold :</p>

<h6>app/models/task.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Task</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">ActiveModel</span><span class="p">:</span><span class="ss">:Dirty</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before_save</span> <span class="ss">:tweet_if_done</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tweet_if_done</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">done_changed?</span>
</span><span class='line'>      <span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks Jason Charnes for the <a href="https://jasoncharnes.com/changed-attributes-rails/">change attribute technique</a>.</p>

<h6>spec/models/task_spec.rb</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="no">Task</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:model</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;is valid with all attributes set&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Finish presentation&quot;</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;requires a description&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_invalid</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_invalid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;tweets when a task is finished&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Wash the car&quot;</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:update</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;Wash the car&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is pretty simple and to the point !</p>

<h3>5 years later</h3>

<p>Now let&rsquo;s imagine that the app grew to tens of thousands of lines. We added a lot of features to the app, which transformed the TODO domain into a very complex thing. Now suppose that, for the sake of maintenance, we want to isolate the domain logic into its own hexagon. Unlike traditional Rails ActiveRecords, we want to make it independent from the database. We also want it to be independent from the Twitter API.</p>

<p>Here is what the code might look like.</p>

<h6>lib/core/task.rb</h6>

<p>First, we have a core task class, independent from anything else. The Core module is our hexagon.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Core</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Task</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:description</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:db_id</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>      <span class="vi">@description</span><span class="o">=</span> <span class="s2">&quot;What do you need to do ?&quot;</span>
</span><span class='line'>      <span class="vi">@done</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@done_subscribers</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">done?</span>
</span><span class='line'>      <span class="vi">@done</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">mark_as_done</span>
</span><span class='line'>      <span class="vi">@done</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@done_subscribers</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="nb">proc</span><span class="o">|</span> <span class="nb">proc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">attributes</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">description</span><span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span> <span class="k">unless</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:description</span><span class="o">].</span><span class="n">nil?</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">mark_as_done</span> <span class="k">if</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:done</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">notify_when_done</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">proc</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@done_subscribers</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">proc</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">description</span><span class="o">=</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
</span><span class='line'>      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Task description cannot be blank&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>
</span><span class='line'>      <span class="vi">@description</span> <span class="o">=</span> <span class="n">desc</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, it contains only domain logic and nothing else.</p>

<h6># spec/lib/core/task_spec.rb</h6>

<p>Here is the corresponding test, fast, mock-free and independent from the database and any external system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;core/task&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span> <span class="s1">&#39;Task&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:task</span><span class="p">)</span> <span class="p">{</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;is not done by default&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_done</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;comes with a default description&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_blank</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;it can be initialized from a hash&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;Old description&quot;</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;Old description&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_done</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;can have a custom description&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="o">=</span> <span class="s2">&quot;Clean up the house&quot;</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;Clean up the house&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;forbids empty descriptions&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;can be done&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">mark_as_done</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_done</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;publishes when done&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">done_task</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">notify_when_done</span> <span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">done_task</span> <span class="o">=</span> <span class="n">t</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">mark_as_done</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">done_task</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;can be updated with a hash&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;New description&quot;</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">&quot;New description&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_done</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">specify</span> <span class="s1">&#39;has no DB id by default&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_nil</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h6># lib/infrastructure/task_repo.rb</h6>

<p>To read and save with the database, we now go through an adapter. This is not considered to be part of our core domain.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Infrastructure</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">TaskRepo</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span>
</span><span class='line'>      <span class="no">Task</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">db_task</span><span class="o">|</span>
</span><span class='line'>        <span class="n">from_db</span><span class="p">(</span><span class="n">db_task</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="n">db_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">from_db</span><span class="p">(</span><span class="no">Task</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">db_id</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">db_id</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>        <span class="n">db_task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">to_db_attributes</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
</span><span class='line'>        <span class="n">task</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_task</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">db_task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>
</span><span class='line'>        <span class="n">db_task</span><span class="o">.</span><span class="n">update!</span><span class="p">(</span><span class="n">to_db_attributes</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">task</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">task</span><span class="o">.</span><span class="n">db_id</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>        <span class="n">db_task</span> <span class="o">=</span> <span class="no">Task</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">db_id</span><span class="p">)</span>
</span><span class='line'>        <span class="n">db_task</span><span class="o">.</span><span class="n">destroy!</span>
</span><span class='line'>        <span class="n">task</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_db_attributes</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">description</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="ss">done</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">done?</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_db</span><span class="p">(</span><span class="n">db_task</span><span class="p">)</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="n">db_id</span> <span class="o">=</span> <span class="n">db_task</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">db_task</span><span class="o">.</span><span class="n">description</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="n">mark_as_done</span> <span class="k">if</span> <span class="n">db_task</span><span class="o">.</span><span class="n">done?</span>
</span><span class='line'>      <span class="n">result</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h6># app/controllers/tasks_controller.rb</h6>

<p>Finally, all the pieces interact together in the controller. This controller basically does what the previous version was, it&rsquo;s just using different classes. Obviously, we&rsquo;ll need to adapt the views and the tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;core/task&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;infrastructure/task_repo&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TasksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:set_task</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /tasks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@tasks</span> <span class="o">=</span> <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /tasks/1</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /tasks/new</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="vi">@task</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /tasks/1/edit</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># POST /tasks</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="vi">@task</span> <span class="o">=</span> <span class="ss">Core</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>
</span><span class='line'>      <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">task_url</span><span class="p">(</span><span class="vi">@task</span><span class="o">.</span><span class="n">db_id</span><span class="p">),</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully created.&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">ArgumentError</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">:new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># PATCH/PUT /tasks/1</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="vi">@task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_params</span><span class="p">)</span>
</span><span class='line'>      <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">task_url</span><span class="p">(</span><span class="vi">@task</span><span class="o">.</span><span class="n">db_id</span><span class="p">),</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully updated.&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">ArgumentError</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">:edit</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># DELETE /tasks/1</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">tasks_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;Task was successfully destroyed.&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_task</span>
</span><span class='line'>      <span class="vi">@task</span> <span class="o">=</span> <span class="ss">Infrastructure</span><span class="p">:</span><span class="ss">:TaskRepo</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@task</span><span class="o">.</span><span class="n">notify_when_done</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>        <span class="ss">TwitterClient</span><span class="p">:</span><span class="ss">:Client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Never trust parameters from the scary internet, only allow the white list through.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">task_params</span>
</span><span class='line'>      <span class="n">params</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:done</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main gain here is that our core domain, our most valuable asset is now easy to test without mocks. This means that we are able to write and execute fast tests for this area of the code. This puts us in a great position to increase our competitive advantage in our core business !</p>

<blockquote><p>ðŸ’¡ By keeping your tests around your core domain fast, Hexagonal Architecture increases your competitive advantage.</p></blockquote>

<p>As you can see, we are now wiring everything together at the controller level. We could later build a facade to isolate the controller from the inside of our domain. A <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter">presenter</a> might do, but it seemed over-engineered, even in this made up example. (I&rsquo;ll post something about that some day)</p>

<h2>Next post</h2>

<p>As we can deduce from the controller code above, we still have to use fakes or mocks when testing the controller. The good thing though is that this is now more local which already makes mocking less of an issue. If a mock is used in less tests, it&rsquo;s easier to use the same mock everywhere ! This is a great opportunity for simplifying test setup, as we&rsquo;ll see in the <a href="/get-rid-of-mocking-maintenance-with-full-fledged-in-memory-fakes/">next post about in-memory fakes</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/how-custom-assertion-matchers-will-keep-mocks-away/">How Custom Assertion Matchers Will Keep Mocks Away</a></h1>
    
    
      <p class="meta">
        








  



<time datetime="2018-05-17T06:47:00+02:00" pubdate data-updated="true">May 17<span>th</span>, 2018</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I cannot write a <a href="/blog/categories/how-to-avoid-mocks-series/">series about avoiding mocks</a> without mentioning Custom Assertion Matchers. If you don&rsquo;t know what custom assertions are, here is pseudo code that uses a custom assertion :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>assert.that(actual, VerifiesMyCustomAssertion(withCustomProperties))</span></code></pre></td></tr></table></div></figure>


<p>For more details, have a look at these examples for your preferred language : <a href="http://joel-costigliola.github.io/assertj/assertj-core-custom-assertions.html">Java</a>, <a href="https://relishapp.com/rspec/rspec-expectations/docs/custom-matchers">Ruby</a> or <a href="http://tonylukasavage.com/blog/2014/05/29/custom-assertions-in-should-dot-js/">Javascript</a>.</p>

<p><img src="http://philippe.bourgau.net/imgs/2018-05-15-how-custom-assertion-matchers-will-keep-mocks-away/matchers.jpg" alt="A drawing of a box of matches, branded 'Matchers' on top" /></p>

<p>That custom assertion matchers have an effect on mock usage might seem puzzling at first. Let me explain. Us, mere human developers, get lured into mocking when tests become too complicated. By keeping the tests simpler, Custom Assertion Matchers help use to avoid mocks. It&rsquo;s a bit like why test data builders keep mocks at bay.</p>

<blockquote><p>ðŸ’¡ We get lured into mocking when tests become too complicated</p></blockquote>

<p>I already blogged about <a href="/speed-up-the-tdd-feedback-loop-with-better-assertion-messages/">the benefits of Custom Assertion Matchers</a>. Here I&rsquo;m going to dive in their advantages against mocking.</p>

<p>This is the fifth post in a <a href="/blog/categories/how-to-avoid-mocks-series/">series about how to avoid mocks</a>. If you haven&rsquo;t yet, I recommend you to start from <a href="/careless-mocking-considered-harmful/">the beginning</a>.</p>

<h2>Why would we end up with mocks when we don&rsquo;t have matchers ?</h2>

<p>Let&rsquo;s walkthrough a small story. Suppose we are building an e-commerce website. When someone passes an order, we want to notify the analytics service. Here is some very simple code for that.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AnalyticsService</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@items</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="kp">attr_reader</span> <span class="ss">:items</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">order_passed</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">cart</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">cart</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="vi">@items</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">customer</span><span class="p">:</span> <span class="n">customer</span><span class="p">,</span> <span class="ss">item</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Order</span>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">cart</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@customer</span> <span class="o">=</span> <span class="n">customer</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@cart</span> <span class="o">=</span> <span class="n">cart</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@analytics</span> <span class="o">=</span> <span class="n">analytics</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="k">def</span> <span class="nf">pass</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="c1"># launch order processing and expedition  </span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="vi">@analytics</span><span class="o">.</span><span class="n">order_passed</span><span class="p">(</span><span class="vi">@customer</span><span class="p">,</span> <span class="vi">@cart</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Order&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">it</span> <span class="s2">&quot;notifies analytics service about passed orders&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">cart</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Pasta&quot;</span><span class="p">,</span><span class="s2">&quot;Tomatoes&quot;</span><span class="o">]</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">analytics</span> <span class="o">=</span> <span class="no">AnalyticsService</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">order</span><span class="o">.</span><span class="n">pass</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">analytics</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="ss">customer</span><span class="p">:</span> <span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="ss">item</span><span class="p">:</span> <span class="s2">&quot;Pasta&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">analytics</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span><span class="p">(</span><span class="ss">customer</span><span class="p">:</span> <span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="ss">item</span><span class="p">:</span> <span class="s2">&quot;Tomatoes&quot;</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s focus on the tests a bit. We first notice that the verification section is large and difficult to understand. Â Looking in more details, it knows too much about the internals of AnalyticsService. We had to make the items accessor public just for the sake of testing. The test even knows how the items are stored in a list of hashes. If we were to refactor this representation, we would have to change the tests as well.</p>

<p>We could argue that responsibility-wise, our test should only focus on Order. It makes sense for the test to use a mock to verify that the Order calls AnalyticsService as expected. Let&rsquo;s see what this would look like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s2">&quot;notifies analytics service about passed orders&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">cart</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Pasta&quot;</span><span class="p">,</span><span class="s2">&quot;Tomatoes&quot;</span><span class="o">]</span>
</span><span class='line'><span class="err">Â </span><span class="n">analytics</span> <span class="o">=</span> <span class="no">AnalyticsService</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="err">Â </span><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">expect</span><span class="p">(</span><span class="n">analytics</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:order_passed</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â </span><span class="n">order</span><span class="o">.</span><span class="n">pass</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sure, the test code is simpler. It&rsquo;s also better according to good design principles. The only glitch is that we now have a mock in place with all the problems I described <a href="/careless-mocking-considered-harmful/">before</a>.</p>

<p>This might not (yet) be a problem in our example but, for example, the mock &lsquo;cuts&rsquo; the execution of the program. Suppose that someday, the Order starts expecting something from the AnalyticsService. We&rsquo;d then need to &lsquo;simulate&rsquo; the real behavior in our mock. This would make the test very hard to maintain.</p>

<h2>Matchers to the rescue</h2>

<p>Let&rsquo;s see how a matcher could help us here. The idea is to improve on the first &lsquo;state checking&rsquo; solution to make it better than the mock one. We&rsquo;ll extract and isolate all the state checking code in a custom matcher. By factorizing the code in a single matcher, we&rsquo;ll reduce duplication. The matcher remains too intimate with the object, but as it is now unique and well named, it&rsquo;s less of a problem. Plus, as always with matchers, we improved readability.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_been_notified_of_order</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="p">,</span> <span class="n">cart</span><span class="o">|</span>
</span><span class='line'><span class="err">Â </span><span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">analytics</span><span class="o">|</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">cart</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'><span class="err">Â Â Â Â Â </span><span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">analytics</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">customer</span><span class="p">:</span> <span class="n">customer</span><span class="p">,</span> <span class="ss">item</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="k">end</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="kp">true</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Order&#39;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â </span><span class="n">it</span> <span class="s2">&quot;notifies analytics service about passed orders&quot;</span> <span class="k">do</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">cart</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Pasta&quot;</span><span class="p">,</span><span class="s2">&quot;Tomatoes&quot;</span><span class="o">]</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">analytics</span> <span class="o">=</span> <span class="no">AnalyticsService</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">,</span> <span class="n">analytics</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">order</span><span class="o">.</span><span class="n">pass</span>
</span><span class='line'>
</span><span class='line'><span class="err">Â Â Â </span><span class="n">expect</span><span class="p">(</span><span class="n">analytics</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_been_notified_of_order</span><span class="p">(</span><span class="s2">&quot;Philippe&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">)</span>
</span><span class='line'><span class="err">Â </span><span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is how we could summarize the pros and cons of each approach :</p>

<table>
<thead>
<tr>
<th></th>
<th> Assert state          </th>
<th> Mocks                              </th>
<th> Matchers </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> ðŸ‘Ž duplicated code    </td>
<td>ðŸ‘Ž duplicates the program behavior</td>
<td>â¤ï¸ customizable error messages|</td>
</tr>
<tr>
<td></td>
<td>ðŸ‘Ž breaks encapsulation</td>
<td>                                   </td>
<td>â¤ï¸ more readable|</td>
</tr>
<tr>
<td></td>
<td>                       </td>
<td>                                    </td>
<td>ðŸ‘Ž intimacy with the asserted object|</td>
</tr>
<tr>
<td></td>
<td>                       </td>
<td>                                    </td>
<td>â¤ï¸ factorizes the assertion code|</td>
</tr>
</tbody>
</table>


<h2>Design improvements</h2>

<p>Depending on your situation, you might find further design improvements. In our example, a publish-subscribe pattern might do. A better design is likely to fix the encapsulation problem of the matcher. Here again, the custom assertion matchers will help. In most cases, it will be enough to change the implementation of the matchers only.</p>

<blockquote><p>ðŸ’¡ Custom assertion matchers make refactoring easier by factorizing test assertions.</p></blockquote>

<h2>Summary of small-scale techniques</h2>

<p>I&rsquo;m done with small scale mock avoiding techniques. To summarize, the first thing to do is to push for more and more <a href="/how-immutable-value-objects-fight-mocks/">immutable value objects</a>. Not only does it help us to avoid mocks, but it will also provides many benefits for production code. Practices like <a href="/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/">Test Data Builders</a> and Custom Assertion Matchers simplify dealing with Immutable Value Objects in tests. They also help to keep tests small and clean, which is also a great thing against mocks.</p>

<h2>Next post</h2>

<p>In the following posts, I&rsquo;ll look into architecture scale techniques to avoid mocks. I&rsquo;ll start with <a href="/avoid-mocks-and-test-your-core-domain-faster-with-hexagonal-architecture/">Hexagonal architecture</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <div id="google_translate_element"></div>
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'fr', layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL, gaTrack: true, gaId: 'UA-30589315-1'}, 'google_translate_element');
    }
  </script>
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</section>

<section>
	<span>
		<img src="http://www.gravatar.com/avatar/686399bd630ecc9381e4dfec8720816e?s=260" alt="Gravatar of Philippe Bourgau " title="Gravatar of Philippe Bourgau" />
	</span>
</section>

<section>
  <h1><a href="/about-me">About Me</a></h1>
  <p>Philippe Bourgau, eXtreme Programmer and Coach, pushing the limits of XP</p>
  <p>I build high performing and sustainable teams by adapting XP to their unique challenges and context.</p>
  <ul>
    <li><a href="/about-me">Read more &#8230;</a></li>
    <li><a href="http://twitter.com/pbourgau">Twitter</a></li>
    <li><a href="http://www.linkedin.com/pub/philippe-bourgau/8/a92/607">Linkedin</a></li>
    <li><a href="https://dl.dropbox.com/u/206938/cv%20philippe%20bourgau.pdf">Resume</a></li>
  </ul>
</section>
<section>
  <h1>Open Source Projects</h1>
  <ul>
    <li><a href="http://philous-planning-poker.herokuapp.com">Philou&#8217;s Planning Poker</a> : Better poker estimates for remote teams !</li>
    <li><a href="http://philou.github.io/storexplore">Storexplore</a> : Transform online stores into APIs !</li>
    <li><a href="http://philou.github.io/rspecproxies">RSpecProxies</a> : Simplify RSpec mocking with test proxies !</li>
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/philou">@philou</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'philou',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/principles-that-will-make-you-become-a-badass-developer/">Principles that will make you become a badass developer</a>
      </li>
    
      <li class="post">
        <a href="/5-mistakes-badass-developers-never-do/">5 mistakes badass developers never do</a>
      </li>
    
      <li class="post">
        <a href="/why-we-need-badass-developers-to-perform-large-scale-refactorings/">Why we need Badass developers to perform large scale refactorings</a>
      </li>
    
      <li class="post">
        <a href="/how-to-convince-your-business-to-sponsor-a-large-scale-refactoring/">How to convince your business of sponsoring a large scale refactoring</a>
      </li>
    
      <li class="post">
        <a href="/how-to-avoid-unnecessary-meetings-a-takeaway-from-devoxx-france-2018/">How to avoid unnecessary meetings (a takeaway from Devoxx France 2018)</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Friend&#8217;s blogs</h1>
  <ul>
    <li><img class="logo link" src="https://avatars2.githubusercontent.com/u/40221?v=3&s=24" /><a href="https://abailly.github.io/">Arnaud Bailly&#8217;s blog</a></li>
    <li><img class="logo link" src="https://www.murex.com/sites/default/files/favicon.ico" /> <a href="http://www.murex.com/">Murex (my company)</a></li>
    <li><img class="logo link" src="https://avatars0.githubusercontent.com/u/2824069?v=3&s=24" /><a href="http://tpierrain.blogspot.fr/">Thomas&#8217; blog</a></li>
    <li><img class="logo link" src="https://avatars3.githubusercontent.com/u/11088496?v=3&s=24" /><a href="https://ahmadatwi.me/">Ahmad Atwi&#8217;s blog</a></li>
    <li><img class="logo link" src="http://bilal.eltayara.net/favicon.png" /><a href="http://bilal.eltayara.net/">Bilal El Tayara&#8217;s blog</a></li>
    <li><img class="logo link" src="http://sthiery.blogspot.fr/favicon.ico" /><a href="http://sthiery.blogspot.fr/">Sylvain&#8217;s blog (french)</a></li>
    <li><img class="logo link" src="https://avatars2.githubusercontent.com/u/732436?v=3&s=24" /><a href="http://www.pgourlain.fr/">Pierrick&#8217;s website (french)</a></li>
  </ul>
</section>





  
</aside>

      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Philippe Bourgau -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'philippe-bourgau';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
