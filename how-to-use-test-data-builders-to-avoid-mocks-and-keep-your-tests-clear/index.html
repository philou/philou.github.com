<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>How to use Test Data Builders to avoid mocks and keep your tests clear | Philippe Bourgau’s XP Coaching Blog</title>
<meta name="description" content="An explanation of how Test Data Builders prevent excessive mocking. Code examples in Ruby are presented to illustrate the point.">


  <meta name="author" content="Philippe Bourgau">
  
  <meta property="article:author" content="Philippe Bourgau">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Philippe Bourgau's XP Coaching Blog">
<meta property="og:title" content="How to use Test Data Builders to avoid mocks and keep your tests clear">
<meta property="og:url" content="https://philippe.bourgau.net/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/">


  <meta property="og:description" content="An explanation of how Test Data Builders prevent excessive mocking. Code examples in Ruby are presented to illustrate the point.">



  <meta property="og:image" content="https://philippe.bourgau.net/imgs/2018-05-01-how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/crate.jpg">



  <meta name="twitter:site" content="@pbourgau">
  <meta name="twitter:title" content="How to use Test Data Builders to avoid mocks and keep your tests clear">
  <meta name="twitter:description" content="An explanation of how Test Data Builders prevent excessive mocking. Code examples in Ruby are presented to illustrate the point.">
  <meta name="twitter:url" content="https://philippe.bourgau.net/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://philippe.bourgau.net/imgs/2018-05-01-how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/crate.jpg">
  

  



  <meta property="article:published_time" content="2018-05-10T09:56:00+00:00">





  

  


<link rel="canonical" href="https://philippe.bourgau.net/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Philippe Bourgau",
      "url": "https://philippe.bourgau.net/",
      "sameAs": ["https://twitter.com/pbourgau","https://www.linkedin.com/in/philippe-bourgau-607a928/","https://github.com/philou","https://www.youtube.com/channel/UCq6uOPvSmpQeVrLRCQOQ8KQ"]
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Philippe Bourgau's XP Coaching Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single-mailing-list">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Philippe Bourgau's XP Coaching Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about-me/">About Me</a>
            </li><li class="masthead__menu-item">
              <a href="/services/">Services</a>
            </li><li class="masthead__menu-item">
              <a href="/speaking/">Speaking</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/archives/">Archives</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="http://www.gravatar.com/avatar/686399bd630ecc9381e4dfec8720816e?s=260" alt="Philippe Bourgau" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Philippe Bourgau</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Software Development Coach</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Paris, France</span>
        </li>
      

      
        
          
        
          
            <li><a href="/about-me" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/pbourgau" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
        
          
            <li><a href="https://github.com/philou" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/philippe-bourgau-607a928" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
        
          
            <li><a href="https://www.youtube.com/channel/UCq6uOPvSmpQeVrLRCQOQ8KQ" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span></a></li>
          
        
          
            <li><a href="https://www.eventstormingjournal.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-sticky-note" aria-hidden="true"></i><span class="label">Event Storming Journal</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="How to use Test Data Builders to avoid mocks and keep your tests clear">
    <meta itemprop="description" content="We are sometimes tempted to use mocks to shortcut test data initialization. Unfortunately, excessive mocking makes tests difficult to maintain. As Uncle Bob explained, it’s a road that leads to giving up on tests.">
    <meta itemprop="datePublished" content="2018-05-10T09:56:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">How to use Test Data Builders to avoid mocks and keep your tests clear
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>We are sometimes tempted to use mocks to shortcut test data initialization. Unfortunately, excessive mocking makes tests difficult to maintain. As <a href="https://blog.cleancoder.com/uncle-bob/2017/05/05/TestDefinitions.html">Uncle Bob explained</a>, it’s a road that leads to giving up on tests.</p>

<p>Hopefully, <a href="http://www.natpryce.com/articles/000714.html">Test Data Builders</a> both shortcut test data setup and avoid mocks.</p>

<p><img src="https://philippe.bourgau.net/imgs/2018-05-01-how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/crate.jpg" alt="Drawing of a crate" /></p>

<p>This is the fourth post <a href="https://philippe.bourgau.net/categories/#how-to-avoid-mocks-series">of a series about how to avoid mocks</a> in automated tests. If you haven’t yet, I recommend you to start from <a href="https://philippe.bourgau.net/careless-mocking-considered-harmful/">the beginning</a>.</p>

<h2 id="the-problem-with-test-data-initialization">The problem with test data initialization</h2>

<p>Setting up the correct state for automated tests can be pretty verbose. This is especially true for software in complex domains or code with a lot of side effects.</p>

<p>The situation gets worse as tests need to setup similar but not exactly identical data. What I often see in code bases is a lot of test data setup duplication. For example, here are tests for a basic ticketing system.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>
<span class="nb">require</span> <span class="s1">'date'</span>

<span class="n">describe</span> <span class="s1">'Ticket Tracking'</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"with test setup duplication"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s1">'latest change date is the creation date when nothing changed'</span> <span class="k">do</span>
      <span class="n">creation_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

      <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">)</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date when a comment is written'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="n">comment_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="n">comment_time</span><span class="p">))</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">comment_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date of the latest comment'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
      <span class="n">comment_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="n">comment_time</span><span class="p">))</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">comment_time</span><span class="p">)</span>
      <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is time of latest change if after comment'</span> <span class="k">do</span>
      <span class="n">creation_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">)</span>
      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1">## The code under test</span>
<span class="c1">##</span>
<span class="k">class</span> <span class="nc">Ticket</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">)</span>
    <span class="vi">@updated_at</span> <span class="o">=</span> <span class="n">creation_time</span>
    <span class="vi">@comments</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">latest_change</span>
    <span class="p">([</span><span class="vi">@updated_at</span><span class="p">]</span> <span class="o">+</span> <span class="vi">@comments</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:created_at</span><span class="p">)).</span><span class="nf">max</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="vi">@comments</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="nb">attr_reader</span> <span class="ss">:created_at</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="vi">@created_at</span> <span class="o">=</span> <span class="n">time</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>It’s clear that there’s a huge amount of duplication in the tests data setups.</p>

<p>The straightforward fix against that is method extraction. This is the <a href="https://martinfowler.com/bliki/ObjectMother.html">Object Mother pattern</a>. Unfortunately, Object Mother breaks down under the number of variations. Every time you need a new change, you’ll add a parameter to the Object Mother method. Long story short, you’ll end up with code like that :</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s1">'Ticket Tracking'</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"with object mother"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s1">'latest change date is the creation date when nothing changed'</span> <span class="k">do</span>
      <span class="n">creation_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="n">creation_time</span><span class="p">,</span> <span class="p">[])</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date when a comment is written'</span> <span class="k">do</span>
      <span class="n">comment_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="n">comment_time</span><span class="p">])</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">comment_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date of the latest comment'</span> <span class="k">do</span>
      <span class="n">comment_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                             <span class="p">[</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">comment_time</span><span class="p">])</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">comment_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is time of latest change if after comment'</span> <span class="k">do</span>
      <span class="n">creation_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="n">creation_time</span><span class="p">,[</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">create_ticket</span><span class="p">(</span><span class="n">creation_time</span><span class="p">,</span> <span class="n">comment_times</span><span class="p">)</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">)</span>
      <span class="n">comment_times</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment_time</span><span class="o">|</span>
        <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="n">comment_time</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="k">return</span> <span class="n">ticket</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, we have less duplication, but the tests got both unreadable and intricate … Following <a href="https://philippe.bourgau.net/how-immutable-value-objects-fight-mocks/">my advices</a> and using more <a href="https://martinfowler.com/bliki/ValueObject.html">Immutable Value Objects</a> makes the situation worse ! When data is mutable, we can customize it after the call to the Object Mother method. If data is immutable, it all has to be setup at initialization …</p>

<p>That’s when the mock temptation strikes. Sometimes it’s so much easier to mock a method rather than to initialize your data properly. It can be 1 line of mock instead of dealing with all this mess.</p>

<blockquote>
  <p>💡 If you are not careful, messy test initialization code will trick you into using mocks.</p>
</blockquote>

<p>Suppose we now want to make sure we can’t add comments that were written before the ticket was created. We’ll add the following</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s1">'Ticket Tracking'</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="s2">"is not possible to insert a comment before creation data"</span> <span class="k">do</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[])</span>
    <span class="n">expect</span> <span class="k">do</span>
      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Ticket</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span> <span class="k">unless</span> <span class="vi">@updated_at</span> <span class="o">&lt;</span> <span class="n">comment</span><span class="p">.</span><span class="nf">created_at</span>

    <span class="vi">@comments</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

</code></pre></div></div>

<p>Unfortunately, one test (<code class="language-plaintext highlighter-rouge">latest change date is time of latest change if after comment</code>) where we were doing just this, will now fail. The fix would be to find a real situation for this test. Here this could be that the ticket is modified after the latest comment. If the tests are too messy though, a mock can be a quick and dirty fix the setup and make the test pass :</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="s1">'latest change date is time of latest change if after comment'</span> <span class="k">do</span>
  <span class="n">creation_time</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">ticket</span> <span class="o">=</span> <span class="n">create_ticket</span><span class="p">(</span><span class="n">creation_time</span><span class="p">,</span> <span class="p">[])</span>
  <span class="n">comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
  <span class="n">allow</span><span class="p">(</span><span class="n">comment</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="no">DateTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

  <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="n">creation_time</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There is a third way : Test Data Builders</p>

<h2 id="what-are-test-data-builders">What are test data builders</h2>

<p>As often, when design is not satisfying, adding an indirection solves the issue. Here the indirection takes shape of the Builder pattern.</p>

<blockquote>
  <p><em>Builder Pattern [</em><a href="https://en.wikipedia.org/wiki/Builder_pattern"><em>Wikipedia</em></a><em>] :</em></p>
</blockquote>

<blockquote>
  <p>The intent of the Builder design pattern is to separate the construction of a complex object from its representation. By doing so the same construction process can create different representations.</p>
</blockquote>

<p>The idea is to use the builder pattern to build the test data. <a href="https://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627/ref=sr_1_1?ie=UTF8&amp;qid=1525160355&amp;sr=8-1&amp;keywords=growing+object-oriented+software+guided+by+tests">Growing Object Oriented Software Guided by Tests</a> covers this technique in great length.</p>

<p><a href="https://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627/ref=sr_1_1?ie=UTF8&amp;qid=1525160355&amp;sr=8-1&amp;keywords=growing+object-oriented+software+guided+by+tests"><img src="https://philippe.bourgau.net/imgs/2018-05-01-how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/growing.jpg" alt="Cover of the book Growing Object Oriented Software Guided By Tests" /></a></p>

<p>Here is the previous code re-written using the test data builder pattern.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rspec'</span>
<span class="nb">require</span> <span class="s1">'date'</span>

<span class="n">describe</span> <span class="s1">'Ticket Tracking'</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"with test data builders"</span> <span class="k">do</span>

    <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
      <span class="vi">@t</span> <span class="o">=</span> <span class="n">date_times</span><span class="p">.</span><span class="nf">build</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the creation date when nothing changed'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">a_ticket</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">build</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date when a comment is written'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">a_ticket</span>
                   <span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                   <span class="p">.</span><span class="nf">with_comment</span><span class="p">(</span><span class="n">a_comment</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                   <span class="p">.</span><span class="nf">build</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is the comment date of the latest comment'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">a_ticket</span>
                   <span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                   <span class="p">.</span><span class="nf">with_comment</span><span class="p">(</span><span class="n">a_comment</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                   <span class="p">.</span><span class="nf">with_comment</span><span class="p">(</span><span class="n">a_comment</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                   <span class="p">.</span><span class="nf">build</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'latest change date is time of latest change if after comment'</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">a_ticket</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                   <span class="p">.</span><span class="nf">with_comment</span><span class="p">(</span><span class="n">a_comment</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                   <span class="p">.</span><span class="nf">build</span>

      <span class="n">ticket</span><span class="p">.</span><span class="nf">update_description</span><span class="p">(</span><span class="s2">"The widget is not loading when logged in as anonymous"</span><span class="p">,</span> <span class="vi">@t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

      <span class="n">expect</span><span class="p">(</span><span class="n">ticket</span><span class="p">.</span><span class="nf">latest_change</span><span class="p">).</span><span class="nf">to</span> <span class="n">be</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"is not possible to insert a comment before creation data"</span> <span class="k">do</span>
      <span class="n">ticket</span> <span class="o">=</span> <span class="n">a_ticket</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nf">build</span>

      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="n">a_comment</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="vi">@t</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">build</span><span class="p">)</span>
      <span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">## Test Data Builders</span>
<span class="c1">##</span>
<span class="k">class</span> <span class="nc">DateTimeBuilder</span>
  <span class="k">def</span> <span class="nf">build</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">date_times</span><span class="p">()</span>
  <span class="no">DateTimeBuilder</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CommentBuilder</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@at</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">at</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="vi">@at</span> <span class="o">=</span> <span class="n">time</span>
    <span class="nb">self</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">build</span>
    <span class="no">Comment</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Should work now"</span><span class="p">,</span> <span class="s2">"Dan"</span><span class="p">,</span> <span class="vi">@at</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">a_comment</span><span class="p">()</span>
  <span class="no">CommentBuilder</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TicketBuilder</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@at</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span>
    <span class="vi">@comments</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">at</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="vi">@at</span> <span class="o">=</span> <span class="n">time</span>
    <span class="nb">self</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">with_comment</span><span class="p">(</span><span class="n">comment_builder</span><span class="p">)</span>
    <span class="vi">@comments</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">comment_builder</span><span class="p">.</span><span class="nf">build</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">build</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Widget broken"</span><span class="p">,</span> <span class="s2">"The widget is not loading when ..."</span><span class="p">,</span> <span class="s2">"Philippe"</span><span class="p">,</span> <span class="vi">@at</span><span class="p">)</span>
    <span class="vi">@comments</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span>
      <span class="n">ticket</span><span class="p">.</span><span class="nf">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">ticket</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">a_ticket</span><span class="p">()</span>
  <span class="no">TicketBuilder</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>

<span class="c1">## The code under test</span>
<span class="c1">##</span>
<span class="k">class</span> <span class="nc">Ticket</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="n">creation_time</span><span class="p">)</span>
    <span class="vi">@updated_at</span> <span class="o">=</span> <span class="n">creation_time</span>
    <span class="vi">@comments</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">latest_change</span>
    <span class="p">([</span><span class="vi">@updated_at</span><span class="p">]</span> <span class="o">+</span> <span class="vi">@comments</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:created_at</span><span class="p">)).</span><span class="nf">max</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span> <span class="k">unless</span> <span class="vi">@updated_at</span> <span class="o">&lt;</span> <span class="n">comment</span><span class="p">.</span><span class="nf">created_at</span>

    <span class="vi">@comments</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_description</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">update_time</span><span class="p">)</span>
    <span class="vi">@updated_at</span> <span class="o">=</span> <span class="n">update_time</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="nb">attr_reader</span> <span class="ss">:created_at</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="vi">@created_at</span> <span class="o">=</span> <span class="n">time</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, it provides default test values, and we only need to provide the custom values we care about. This makes the test code both readable and intention revealing. Making the tests more understandable helps a lot to find ways to avoid mocks. Here, we replaced the mock on the comment time by an update to the ticket after the last comment.</p>

<p>The pattern applies in many languages, even if implementations will be different. In Ruby, libraries like <a href="https://github.com/thoughtbot/factory_bot">factory_bot</a> avoid a lot of boilerplate code. Have a look at <a href="http://www.natpryce.com/articles/000769.html">this article</a> for examples in Java.</p>

<h2 id="other-advantages">Other advantages</h2>

<p>Test data builders have another second effect benefit. When setting up the data is complicated, we are likely to add more that one assertion in a test. Unit tests can end up looking like a mini scenario to avoid duplicating this test setup.</p>

<p>It’s easy to create a specific tests for every assertion with Test Data Builders. By doing so we get smaller and more focused tests, which bring :</p>

<ul>
  <li>Better names for tests</li>
  <li>More readable tests</li>
  <li>Faster diagnostic of the problem when a particular test fails</li>
  <li>🎁 Better coverage ! In a large test, all assertions work on the same input values. When we have many small tests, we can use a different value in each.</li>
</ul>

<blockquote>
  <p>💡 By simplifying the creation of new tests with different data, Test Data Builders increase code coverage in the long term!</p>
</blockquote>

<h2 id="next-week">Next week</h2>

<p>This is the fourth post of <a href="https://philippe.bourgau.net/categories/#how-to-avoid-mocks-series">a series about how to avoid mocks</a> in automated tests. Next week I’ll dig into Custom Assertion Matchers and how they avoid mock expectations.</p>


<!-- Begin Mailchimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
  <form action="https://bourgau.us18.list-manage.com/subscribe/post?u=b46bc99339f9c9f337232c617&amp;id=ed63184b0e" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
        <label for="mce-EMAIL">Stay up to date with content and upcoming products</label>
        <p>I usually write about 15 minutes worth of reading per month. I won't transfer your email. No Spam, unsubscribe whenever you want.</p>
        <p><em>As a gift for subscribing, you'll receive an illustrated mini-ebook <strong>"How to start a team coding dojo"</strong>!</em></p>
        <p><img src="/imgs/thumbnails/how-to-start-your-team-coding-dojo-cover.jpg"/></p>
        <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_b46bc99339f9c9f337232c617_ed63184b0e" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>

<!--End mc_embed_signup-->

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#how-to-avoid-mocks-series" class="page__taxonomy-item" rel="tag">how-to-avoid-mocks-series</a><span class="sep">, </span>
    
      <a href="/categories/#mocking" class="page__taxonomy-item" rel="tag">mocking</a><span class="sep">, </span>
    
      <a href="/categories/#programming" class="page__taxonomy-item" rel="tag">programming</a><span class="sep">, </span>
    
      <a href="/categories/#ruby" class="page__taxonomy-item" rel="tag">ruby</a><span class="sep">, </span>
    
      <a href="/categories/#tdd" class="page__taxonomy-item" rel="tag">tdd</a><span class="sep">, </span>
    
      <a href="/categories/#testing" class="page__taxonomy-item" rel="tag">testing</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-05-10T09:56:00+00:00">May 10, 2018</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=pbourgau&text=How+to+use+Test+Data+Builders+to+avoid+mocks+and+keep+your+tests+clear%20https%3A%2F%2Fphilippe.bourgau.net%2Fhow-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>


  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fphilippe.bourgau.net%2Fhow-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

  <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fphilippe.bourgau.net%2Fhow-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear%2F&title=How+to+use+Test+Data+Builders+to+avoid+mocks+and+keep+your+tests+clear" class="btn" style="background-color: #ff4500; color: white" title="Share on Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

  <a href="http://news.ycombinator.com/submitlink?u=https%3A%2F%2Fphilippe.bourgau.net%2Fhow-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear%2F&t=How to use Test Data Builders to avoid mocks and keep your tests clear" class="btn" style="background-color: #ff6600; color: white"  title="Share on Hackernews"><i class="fab fa-fw fa-hacker-news" aria-hidden="true"></i><span> Hacker News</span></a>

</section>


      
  <nav class="pagination">
    
      <a href="/immutable-value-objects-vs-mocks-fizz-buzz/" class="pagination--pager" title="Immutable Value Objects vs Mocks : Fizz Buzz
">Previous</a>
    
    
      <a href="/how-custom-assertion-matchers-will-keep-mocks-away/" class="pagination--pager" title="How Custom Assertion Matchers will keep mocks away
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/imgs/2023-11-07-the-secrets-of-tech-coaching-better-communication-skill/human-human-stack-teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/the-secrets-of-tech-coaching-better-communication-skill/" rel="permalink">The Secrets Of Tech Coaching: Better Communication Skill
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Running code katas or mobs with groups that lack teamwork is almost impossible! Here are 20 communication and collaboration techniques to coach by example.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/imgs/2023-07-22-liberating-structures-the-slow-code-retreat-s-little-facilitation-secret/snail-carrying-liberating-structures-teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/liberating-structures-the-slow-code-retreat-s-little-facilitation-secret/" rel="permalink">Liberating Structures: the Slow Code Retreat’s little facilitation secret
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">You can now run the Slow Code Retreat by following the facilitation guide. By doing so, you’ll also learn 6 Liberating Structures for your future workshops.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/imgs/2023-06-04-how-to-fix-bad-agile-by-discussing-baby-steps/baby-steps-aha-moment-teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/how-to-fix-bad-agile-by-discussing-baby-steps/" rel="permalink">How To Fix Bad Agile By Discussing Baby Steps
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">How to fix bad agile by starting neutral discussions about baby-steps programming. Baby steps are a sustainable and productive approach to writing code.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/imgs/2023-04-26-a-quality-view-workshop-to-discuss-technical-excellence/missing-a-quality-view-teaser.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/a-quality-view-workshop-to-discuss-technical-excellence/" rel="permalink">A Quality View Workshop to Discuss Technical Excellence
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          17 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Here is a step-by-step workshop to guide a team to drawing a Quality View. Use it to discuss investment in agile technical excellence with stakeholders.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/pbourgau" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/philou" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
        
          <li><a href="https://www.linkedin.com/in/philippe-bourgau-607a928" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="http://eepurl.com/dxKE95" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope" aria-hidden="true"></i> Mail Feed</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Philippe Bourgau. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0XLKP12EJF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0XLKP12EJF', { 'anonymize_ip': true});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://philippe.bourgau.net/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/how-to-use-test-data-builders-to-avoid-mocks-and-keep-your-tests-clear"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://philippe-bourgau.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
