<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: cucumber | Philippe Bourgau's blog]]></title>
  <link href="http://philippe.bourgau.net/blog/categories/cucumber/atom.xml" rel="self"/>
  <link href="http://philippe.bourgau.net/"/>
  <updated>2013-08-03T08:31:04+02:00</updated>
  <id>http://philippe.bourgau.net/</id>
  <author>
    <name><![CDATA[Philippe Bourgau]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Simplest way to speed up rspec with in memory sqlite db]]></title>
    <link href="http://philippe.bourgau.net/simplest-way-to-speed-up-rspec-with-in-memory-sqlite-db/"/>
    <updated>2013-08-02T09:16:00+02:00</updated>
    <id>http://philippe.bourgau.net/simplest-way-to-speed-up-rspec-with-in-memory-sqlite-db</id>
    <content type="html"><![CDATA[<p>There are already a lot of articles explaining how to setup an in memory <a href="http://www.sqlite.org/">SQLite</a> database to speed up <a href="http://rubyonrails.org/">Rails</a> specs or unit tests. Most of them explain how to change your database.yml and to run setup your schema before running the tests. It works fine.</p>

<p>There&rsquo;s a catch though : suppose you are using <a href="http://cukes.info/">cucumber</a>, it&rsquo;s likely you&rsquo;d rather run cucumber on a real database (<a href="http://www.postgresql.org/">PostgreSQL</a>, <a href="http://www.mysql.com/">MySQL</a> or whatever). Most gems expect cucumber and <a href="http://rspec.info/">rspec</a> to both run in the test environment &hellip; Every time I updated my bundle or that I wanted to use a new test gem, I would hit an issue about cucumber being run in its own &lsquo;cucumber&rsquo; environment : unexpected warnings and things not working out of the box.</p>

<p>Eventually, I ditched the cucumber env, setup a PostgreSQL db on the test env, and injected the in memory sqlite database right inside spec_helper.rb :</p>

<p>In database.yml :</p>

<p><code>yaml
test:
  adapter: postgresql
  database: mes_courses_test
  encoding: utf8
  pool: 5
  timeout: 5000
  username: mes_courses
  password: secret
  host: localhost
  port: 5433
</code></p>

<p>At the bottom of spec_helper.rb</p>

<p>```ruby
setup_sqlite_db = lambda do
  ActiveRecord::Base.establish_connection(adapter: &lsquo;sqlite3&rsquo;, database: &lsquo;:memory:&rsquo;)</p>

<p>  load &ldquo;#{Rails.root.to_s}/db/schema.rb&rdquo; # use db agnostic schema by default
  # ActiveRecord::Migrator.up(&lsquo;db/migrate&rsquo;) # use migrations
end
silence_stream(STDOUT, &amp;setup_sqlite_db)
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Don't repeat names in cucumber scenarios]]></title>
    <link href="http://philippe.bourgau.net/dont-repeat-names-in-cucumber-scenarios/"/>
    <updated>2013-05-09T08:35:00+02:00</updated>
    <id>http://philippe.bourgau.net/dont-repeat-names-in-cucumber-scenarios</id>
    <content type="html"><![CDATA[<p>When the same name is repeated all over the place in a cucumber scenario, it can be difficult to read.
<code>gherkin
Scenario: Withdrawing some cash
  Given a deposit account with 1000€
  When I withdraw 100€ from the deposit account
  Then there should be 900€ on the deposit account
</code>
It would be better if we could write it like that
<code>gherkin
Scenario: Withdrawing some cash
  Given a deposit account with 1000€
  When I withdraw 100€ from the account
  Then there should be 900€ on the account
</code>
Sometimes we actually want to repeat the names though, either for clarity, or if we are dealing with many accounts within the same scenario.</p>

<p>To make both my scenarios more readable and my steps more versatile, I created special main_account_name accessors and a custom transform.
```ruby
def main_account_name
  @main_account_name ||= &ldquo;credit&rdquo;
end
def main_account_name=(account_name)
  @main_account_name ||= account_name
end</p>

<p>CAPTURE_ACCOUNT_NAME = Tranform(/^(a|an|the) <em>(.</em>) account$/) do |_prefix, account_name|
  if account_name == &ldquo;&rdquo;</p>

<pre><code>main_account_name
</code></pre>

<p>  else</p>

<pre><code>account_name
</code></pre>

<p>  end
end
<code>
When creating the account, I added some code to set the main_account_name
</code>ruby
Given(/^(#{CAPTURE_ACCOUNT_NAME}) with (\d+)€$/) do |account_name, amount|
  &hellip;
  self.main_account_name= account_name
end
<code>
It is then possible to write steps like
</code>
When(/^I withdraw (\d+)€ from (#{CAPTURE_ACCOUNT_NAME})$/) do |amount, account_name|
  &hellip;
end
```
that will match both &ldquo;the deposit account&rdquo; and &ldquo;the account&rdquo; depending on context.</p>

<p>It would be really nice to be able to write things like
<code>gherkin
  Then there should be 900€ on it
</code>
but because of the <a href="/if-new-cucumber-transform-breaks-everyhing-dot-dot-dot/">way cucumber handles transforms</a>, the only way I know to do that is to write a new step definition.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[If new cucumber transform breaks everyhing ...]]></title>
    <link href="http://philippe.bourgau.net/if-new-cucumber-transform-breaks-everyhing-dot-dot-dot/"/>
    <updated>2013-05-08T08:36:00+02:00</updated>
    <id>http://philippe.bourgau.net/if-new-cucumber-transform-breaks-everyhing-dot-dot-dot</id>
    <content type="html"><![CDATA[<p>After reading <a href="http://pragprog.com/book/hwcuc/the-cucumber-book">The cucumber book</a> I decided to add clever cucumber transforms but steps started to fail all over the place &hellip; Even completly unrelated scenarios were failing &hellip;</p>

<p>I should have read the <a href="https://github.com/cucumber/cucumber/wiki/Step-Argument-Transforms">Cucumber transforms doc page</a> and particularly the &ldquo;Transforms wisdom&rdquo; section before anything, it would have been a real time saver. To summarise, when a step is executed, all transforms regexps are tried on the step captures, and the first matching transform is applied ! Inlining the transform global inside the step regex removes duplication, but in no way does it imply which transform will be applied !</p>

<p>For example</p>

<p>```ruby
CAPTURE_NUMBER = Transform /^.*$/ do |digits|
  Float(digits)
end</p>

<p>When /^I withdraw (#{CAPTURE_NUMBER}) from &ldquo;([^&rdquo;]+)&ldquo;$/ do |amount, bank_name|
  bank = Bank.find_by_name(bank_name)
  bank.withdraw(amount)
end
```</p>

<p>will match the bank name with CAPTURE_NUMBER, and you&rsquo;ll get an &ldquo;invalid value for Float&rdquo; error.</p>
]]></content>
  </entry>
  
</feed>
