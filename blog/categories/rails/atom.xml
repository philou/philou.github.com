<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rails | Philippe Bourgau's blog]]></title>
  <link href="http://philippe.bourgau.net/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://philippe.bourgau.net/"/>
  <updated>2018-06-22T06:33:19+02:00</updated>
  <id>http://philippe.bourgau.net/</id>
  <author>
    <name><![CDATA[Philippe Bourgau]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[What Rails teaches us about building platforms and frameworks]]></title>
    <link href="http://philippe.bourgau.net/what-rails-teaches-us-about-building-platforms-and-frameworks/"/>
    <updated>2017-10-09T09:20:00+02:00</updated>
    <id>http://philippe.bourgau.net/what-rails-teaches-us-about-building-platforms-and-frameworks</id>
    <content type="html"><![CDATA[<p>More than ever, the cheapest way to build a framework is to refactor it out of a specific app.</p>

<p><a href="http://rubyonrails.org/">Rails</a> is a web development server side framework built in <a href="https://www.ruby-lang.org/">Ruby</a>. It&rsquo;s been and remains very popular. It set the tone for all the <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">MVC</a> web frameworks that followed. People have ported it to many other languages. Rails is now in it&rsquo;s 5th version, what is less known is how it was built in the first place.</p>

<p><img src="../imgs/2017-10-09-what-rails-teaches-us-about-building-platforms-and-frameworks/train-and-rails.jpg" alt="Drawing of a train being detached from its rails" /></p>

<h2>The story of Rails</h2>

<p><a href="http://david.heinemeierhansson.com/">David Heinemeier Hansson</a>, the creator of Rails, is a cult in the Ruby community. You can find the history of Rails at many places. If you have a bit of time, read <a href="https://www.wired.com/2008/02/mf-signals/?currentPage=all">this great article</a> from Wired. If you don&rsquo;t have a lot of time, here is a summary.</p>

<p><a href="https://twitter.com/jasonfried?lang=fr">Jason Fried</a> and DHH were working at <a href="https://37signals.com/">37signals</a>. They were working on project management app for small businesses called <a href="https://basecamp.com/">Basecamp</a>. After releasing the first version of Basecamp, DHH extracted and open sourced Rails out of it.</p>

<p>37signals later then re-used Rails to build other apps like Campfire, Highrise and Backpack.</p>

<p>We all know the end of the story, Rails adoption exploded. Many successful companies like <a href="https://github.com/">Github</a>, <a href="https://www.airbnb.com/">Airbnb</a>, <a href="https://twitter.com">Twitter</a> &amp; <a href="https://www.shopify.com">Shopify</a> have used it. It evolved a lot, through the darwinism of open source. Today, Rails might not be the latest and coolest web framework, but it is still very productive and popular.</p>

<p><img src="../imgs/2017-10-09-what-rails-teaches-us-about-building-platforms-and-frameworks/rails-logo.jpg" alt="The Rails logo" /></p>

<h2>Economic sense</h2>

<p>To summarize, here is how they did it :</p>

<ol>
<li>Built a specific app, and monetized it</li>
<li>Extracted an open source framework from it</li>
<li>Built other apps on the framework</li>
</ol>


<p>If you are not a programmers, you&rsquo;re likely to assume that the cost of reusing software is negligible. If you are a programmer, I&rsquo;ll ask you to assume that it is for a while. Â Under this hypothesis, all they did makes a lot of business sense :</p>

<ul>
<li>Building a specific app first is the fastest path to paying customers. Building a framework first would need more work.</li>
<li>Once you have paying customers, you&rsquo;ve got money to fuel further work.</li>
<li>In particular, you have money to finance the extraction of an open source framework.</li>
<li>Putting the framework open source increases its reusability through bug reports and contributions.</li>
<li>Building the next app is even easier thanks to a mature framework and the revenues from the original app</li>
</ul>


<blockquote><p>ðŸ’¡ Once you have paying customers, you&rsquo;ve got money to fuel further work.</p></blockquote>

<h2>How can it work ?</h2>

<p><a href="https://www.amazon.com/Rework-Jason-Fried/dp/0307463745/ref=sr_1_1?ie=UTF8&amp;qid=1507610064&amp;sr=8-1&amp;keywords=rework"><img src="../imgs/2017-10-09-what-rails-teaches-us-about-building-platforms-and-frameworks/rework-cover.jpg" alt="Cover of Rework book" /></a></p>

<p>Ok, enough for common sense. Let&rsquo;s see what happens when you take into account the real cost of changing software ? All software developers know that changing software is far from cheap. Very often, it&rsquo;s more expensive to adapt than to rebuild</p>

<p>So how did the Rails guys manage it ? Rails has 3 specificities that explain that :</p>

<ul>
<li>Rails has automated testing built in and out</li>
<li>Basecamp guys are agile with a lower &lsquo;a&rsquo;. They don&rsquo;t follow Scrum or any method. Read <a href="https://basecamp.com/about/books">their books</a> and you&rsquo;ll understand how agile they are. They follow principles like KISS, YAGNI, Lean startup discovery &hellip;</li>
<li>Finally, it was open sourced !</li>
</ul>


<p>Agile principles and technical practices is what allowed them to take the common-sense path.</p>

<blockquote><p>ðŸ’¡ Thanks to agile practices, the cheapest way to build a framework is to extract it from a specific app.</p></blockquote>

<h2>Open question</h2>

<p>If it is possible to do the thing that makes the most economic sense, why isn&rsquo;t it the default way ? Why are so many of us still losing a ton of money writing large frameworks and platforms up-front ? How could we get large companies to adopt the more nimble &lsquo;basecamp&rsquo; way ?</p>

<p><em>If you have remarks, answers or different point of views, I&rsquo;d love to read your comment !</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to subscribe to an ActionCable channel on a specific page with custom data ?]]></title>
    <link href="http://philippe.bourgau.net/how-to-subscribe-to-an-actioncable-channel-on-a-specific-page-with-custom-data/"/>
    <updated>2017-02-23T05:25:00+01:00</updated>
    <id>http://philippe.bourgau.net/how-to-subscribe-to-an-actioncable-channel-on-a-specific-page-with-custom-data</id>
    <content type="html"><![CDATA[<p>In my spare time, I&rsquo;m writing a <a href="https://github.com/philou/planning-poker">Planning Poker App</a>. As a reminder, planning poker is a group estimation technique designed to eliminate influence bias. Participants keeps their estimates secret until everyone unveils them at the same time (See <a href="https://en.wikipedia.org/wiki/Planning_poker">Wikipedia</a> for more details).</p>

<p>The driving idea behind my app is for team members to connect together and share a view of the current vote happening in their team. Each team has an animator, who is responsible to start new votes. This is the aspect I&rsquo;ve been working on during the last few days. I want all team members to be notified that a new vote started by displaying a countdown on their page.</p>

<p>I am building the app with <a href="http://rubyonrails.org/">Rails 5</a> but I did not have a clear idea of what technology to use to build this feature. After some googling, I found that ActionCable provides just the kind of broadcasting I am looking for (Have a look at the <a href="http://edgeguides.rubyonrails.org/action_cable_overview.html">ActionCable Rails guide</a> for more details).</p>

<h2>A Specific Page</h2>

<p>The Rails guide is pretty clear, as usual I would say, but all the examples show subscriptions at any page load. As explained above, I only want participants to subscribe to their own team&rsquo;s votes : until they have joined a team, it is not possible to subscribe to a particular channel.</p>

<p>As my app is currently behaving, once identified, participants get to a specific team page. I wanted to use this page as the starting point to my subscription. After some more googling about page specific JavaScript in Rails, I found <a href="http://brandonhilkert.com/blog/organizing-javascript-in-rails-application-with-turbolinks/">this page</a> from Brandon Hilkert that explains how to do this cleanly. The idea is to add the controller and action names to the body tag, and to filter out js code at page load. This is what I ended up doing :</p>

<p>First, I adapted the app layout to keep track of the controller and action names in the HTML body :
``` html</p>

<!-- app/layouts/application.html.erb -->


<p>&lt;!DOCTYPE html>
<html>
  &hellip;
  <body class="<%= controller_name %> &lt;%= action_name %>&ldquo;></p>

<pre><code>...
</code></pre>

<p>  </body>
</html>
```</p>

<p>Then I replaced the default channel subscription with a function :
``` coffeescript</p>

<h1>app/assets/javascripts/channels/team.coffee</h1>

<p>window.App.Channels ||= {}
window.App.Channels.Team ||= {}</p>

<p>App.Channels.Team.subscribe = &ndash;>
  App.cable.subscriptions.create &ldquo;TeamChannel&rdquo;,</p>

<pre><code>received: (data) -&gt;
  # Do something with this data
</code></pre>

<p>```</p>

<p>As a reminder, here is what the server side channel would look like :
``` ruby
class TeamChannel &lt; ApplicationCable::Channel
  def subscribed</p>

<pre><code>stream_from "team_channel"
</code></pre>

<p>  end
end
```</p>

<p>Finally, I called this subscribe function from some page specific Javascript :
``` coffeescript</p>

<h1>app/assets/team_members.coffee</h1>

<p>$(document).on &ldquo;turbolinks:load&rdquo;, &ndash;>
  return unless $(&ldquo;.team_members.show&rdquo;).length > 0</p>

<p>  App.Channels.Team.subscribe()
```</p>

<p>That&rsquo;s it. By playing around in your browser&rsquo;s js console, you should be able to test it.</p>

<h2>Custom Data</h2>

<p>That&rsquo;s just half of the story. The code above subscribes on a specific page, but it does not specify any particular team channel to subscribe to. This means that all participants would receive notifications from all teams !</p>

<p>In his article about unobtrusive JavaScript in Rails, Brandon Hilkert also suggests using HTML data attributes to pass parameters to the a JavaScript button event handler. There&rsquo;s no button in our case, but we can still use the same technique. Let&rsquo;s add data specific attributes to the HTML body.</p>

<p>To subscribe to specific team channel, the plan is to add the team name to the HTML body tag through a data attribute, then to capture and use this team name when subscribing.</p>

<p>Again, let&rsquo;s enhance the layout :
``` html</p>

<!-- app/layouts/application.html.erb -->


<p>&lt;!DOCTYPE html>
<html>
  &hellip;
  <body class="<%= controller_name %> &lt;%= action_name %>&ldquo; &lt;%= yield :extra_body_attributes %> ></p>

<pre><code>...
</code></pre>

<p>  </body>
</html>
```</p>

<p>I had to adapt my views. In the team members show view (the one doing the subscription), I added an extra data attribute for the team name :</p>

<p>``` html</p>

<!-- app/views/team_members/show.html.erb -->


<p>&lt;% provide(:extra_body_attributes, raw(&ldquo;data-team-name=\&rdquo;#{@team.name}\&ldquo;&rdquo;)) %></p>

<p>&hellip;
```</p>

<p>With this done, it is possible to capture the team name from the page load event and feed it to the subscribe method :
``` coffeescript</p>

<h1>app/assets/team_members.coffee</h1>

<p>$(document).on &ldquo;turbolinks:load&rdquo;, &ndash;>
  return unless $(&ldquo;.team_members.show&rdquo;).length > 0</p>

<p>  App.Channels.Team.subscribe($(&lsquo;body&rsquo;).data(&lsquo;team-name&rsquo;))
```</p>

<p>I then used the team name to subscribe to a specific channel :
``` coffeescript</p>

<h1>app/assets/javascripts/channels/team.coffee</h1>

<p>window.App.Channels ||= {}
window.App.Channels.Team ||= {}</p>

<p>App.Channels.Team.subscribe = (teamName) &ndash;>
  App.cable.subscriptions.create {channel: &ldquo;TeamChannel&rdquo;, team_name: teamName},</p>

<pre><code>received: (data) -&gt;
  # Do something with this data
</code></pre>

<p>```</p>

<p>The last piece is to actually start a specific channel :
``` ruby
class TeamChannel &lt; ApplicationCable::Channel
  def subscribed</p>

<pre><code>stream_from "team_channel_#{params[:team_name]}"
</code></pre>

<p>  end
end
```</p>

<p>Same as before, hack a bit with your browser&rsquo;s console, you should be able to check that it&rsquo;s working.</p>

<h2>Last thoughts</h2>

<p>This is not exhaustive, depending on your situation, there might be other things you&rsquo;ll need to do, like unsubscriptions for example.</p>

<p>I&rsquo;d also like to give a word of feedback about ActionCable after this first look at it. Overall, it worked great both in development and production. Everything seemed to work almost out of the box &hellip; Except testing : I did not manage to write robust unit tests around it. There is <a href="https://github.com/rails/rails/pull/23211">pull request</a> for that that should be merged in Rails 5.~ sometimes soon. For the moment, I&rsquo;m sticking to large scale cucumber tests.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How I finally use Docker on small open source side projects]]></title>
    <link href="http://philippe.bourgau.net/how-i-finally-use-docker-on-small-open-source-side-projects/"/>
    <updated>2017-02-16T19:37:00+01:00</updated>
    <id>http://philippe.bourgau.net/how-i-finally-use-docker-on-small-open-source-side-projects</id>
    <content type="html"><![CDATA[<p>A few months ago, I started <a href="https://github.com/philou/planning-poker">Philou&rsquo;s Planning Poker</a>, an open source side project to run <a href="https://en.wikipedia.org/wiki/Planning_poker">planning poker estimate sessions</a> remotely. The main technology is <a href="http://rubyonrails.org/">Rails</a>, and I&rsquo;d been planning to use <a href="https://www.docker.com/">Docker</a> as much as possible as a way to learn it. Indeed, I learned that Docker is no Silver Bullet !</p>

<p><img class="center" src="/imgs/2017-02-16-how-i-finally-use-docker-on-small-open-source-side-projects/docker-silver-bullet.jpg" title="The Docker logo next to a silver bullet" ></p>

<h2>The Docker love phase</h2>

<p>At first everything seemed great about Docker. I&rsquo;d used it on toy projects and it proved great to quickly setup cheap and fast virtual machines. I even created the <a href="https://github.com/philou/rubybox">Rubybox</a> project on Github to clone new ruby VMs in a matter of seconds. I also used Docker to host my <a href="http://octopress.org/">Octopress</a> environment to write this blog. As a long time Linux user, my dev machines have repeatedly been suffering from pollution : after some time, they get plagued with all the stuff I installed to do my various dev experiments, and at some point, re-install seems easier than cleaning up all the mess. If I could use containers for all my projects, Docker would be a cure for this.</p>

<p>Going through all these successes, when I started my planning poker app, I decided to go all into Docker, development, CI and deployment. You can read the log of how I did that in <a href="http://philippe.bourgau.net/blog/categories/docker/">these posts</a>. Fast forward a bit of searching, experimenting and deploying, all was setup : my dev env was in containers, my CI was running in containers in <a href="https://circleci.com/gh/philou/planning-poker/tree/master">CircleCI</a> and the app was pushed to containers on <a href="https://www.digitalocean.com/">DgitalOcean</a>.</p>

<h2>Reality strikes back</h2>

<p>At first, everything seemed to be working fine. Even if there were a few glitches that I would have to fix down the road like :</p>

<ul>
<li>Whenever I wanted to update my app&rsquo;s dependencies, I had to run <code>bundle update</code> twice, and not incrementally. Surely, I would manage to fix that with a bit of time</li>
<li>Obviously, the CI was slower, because it had to build the containers before deploying them to <a href="https://hub.docker.com/">Docker Hub</a>, but that was the price to pay in order to know exactly what was running on the server &hellip; right ?</li>
<li>And &hellip; <a href="https://github.com/guard/guard">Guard</a> notifications did not appear on my desktop. I was accessing my dev env through ssh, so I would have to fix that, just a few hours and it should be working</li>
</ul>


<p>After a while, I got used to my work environment and became almost as productive as I used to be &hellip; but you know, shit happens !</p>

<ul>
<li>I had to install <a href="http://phantomjs.org/">PhantomJS</a> on my CI, and if that comes out of the box on <a href="https://travis-ci.org/">TravisCI</a>, you&rsquo;re all alone in your own containers. Installing this on the Debian container proved unnecessarily complex, but I figured it out</li>
<li>Then all of a sudden, my CI started to break &hellip; You can read a summary of what I did to fix it <a href="/how-i-fixed-devicemapper-error-when-deploying-my-docker-app/">here</a>. Long story short : I had forgotten to clean up old docker images, and after enough deployments, the server ran out of space, and that corrupted the docker cache somehow. I eventually re-installed and upgraded the deployment VM. That made me lose quite some time though.</li>
<li>Finally, as I started to play with <a href="https://github.com/rails/actioncable">ActionCable</a>, I could not get the web-socket notifications through my dev host. There must be some settings and configuration to make this work, for sure, but it&rsquo;s supposed to work out of the box.</li>
</ul>


<p>Eventually, this last issue convinced me to change my setup. All these usages of Docker where definitely worth it from a learning point of view, but as my focus moved to actually building the app, it was time to take pragmatic decisions.</p>

<h2>My use of Docker now</h2>

<p>There were 2 main ideas driving my changes to my dev env for this open source side project :</p>

<ol>
<li>Use the thing most people do</li>
<li>Use commercially supported services &amp; tools</li>
</ol>


<p>These should avoid losing my time instead of being productive. My setup is now almost boring ! To summarize I now use <a href="https://travis-ci.org/philou/planning-poker">TravisCI</a>, <a href="https://philous-planning-poker.herokuapp.com/">Heroku</a>, and <a href="https://github.com/rbenv/rbenv">rbenv</a> on my physical machine. I kept Docker where it really shines : all the local servers required for development are managed by <a href="https://docs.docker.com/compose/">Docker Compose</a>. Here is my <a href="https://github.com/philou/planning-poker/blob/master/docker-compose.yml"><code>docker-compose.yml</code></a></p>

<p>```yaml
db:
  image: postgres:9.4.5
  volumes:</p>

<pre><code>- planning-poker-postgres:/var/lib/postgresql/data
</code></pre>

<p>  ports:</p>

<pre><code>- "5432:5432"
</code></pre>

<p>redis:
  image: redis:3.2-alpine
  volumes:</p>

<pre><code>- planning-poker-redis:/var/lib/redis/data
</code></pre>

<p>  ports:</p>

<pre><code>- "6379:6379"
</code></pre>

<p>```</p>

<p>This saves me from installing <a href="https://www.postgresql.org/">Postgresql</a> or <a href="https://redis.io/">Redis</a> on my dev machine, and I can start all the services required for app with a single <code>docker-compose up</code> command !</p>

<h2>My future uses of Docker</h2>

<p>More generally, in the near future, here is when I&rsquo;ll use docker</p>

<ul>
<li>As I just said, to manage local servers</li>
<li>To boot quick and cheap VMs (check <a href="https://github.com/philou/rubybox">rubybox</a>)</li>
<li>To handle CI and deployment of large or non-standard systems, where Docker can provide a lot of benefits in terms of price, scaling or configurability</li>
</ul>


<p>Docker came from the deployment world, and this is where it is so great. As of today though, even if it is usable as dev VM, it is still not up to a standard dev machine. Despite that, all the issues I ran into could be fixed, and I&rsquo;m pretty sure they&rsquo;ll be some day.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[5 minutes hack to speed up RSpec in Rails 5 using in-memory SQLite]]></title>
    <link href="http://philippe.bourgau.net/5-minutes-hack-to-speed-up-rspec-in-rails-5-using-in-memory-sqlite/"/>
    <updated>2017-01-25T07:53:00+01:00</updated>
    <id>http://philippe.bourgau.net/5-minutes-hack-to-speed-up-rspec-in-rails-5-using-in-memory-sqlite</id>
    <content type="html"><![CDATA[<p>Here is the story : you have a <a href="http://rubyonrails.org/">Rails 5</a> app that uses <a href="http://rspec.info/">RSpec</a>, but your RSpec suite is getting slower and slower to run. You&rsquo;ve already considered some solutions :</p>

<ul>
<li>Use <a href="https://sqlite.org/">SQLite</a> in memory for your test env.</li>
</ul>


<p><code>yaml
test:
  adapter: sqlite3
  database: ":memory:"
</code></p>

<p>That&rsquo;s the most straightforward thing to do, but unfortunately, if you are sharing your test env with <a href="https://cucumber.io/">Cucumber</a>, you might want to use a production like DB with Cucumber (<a href="https://www.postgresql.org/">PostgreSQL</a> or whatever). So unless you are ready to setup a new env for cucumber (which I tried and don&rsquo;t recommend) you&rsquo;re stuck.</p>

<ul>
<li>Use mocks. That&rsquo;s surely going to work, it&rsquo;s going to make your test hell of a lot faster ! It will also make your tests a lot more fragile and more expensive to maintain &hellip; If you want to read more about why I think mocks are a bad idea, just have a look at <a href="/blog/categories/mocking/">these posts</a>.</li>
</ul>


<h2>The hack</h2>

<p>Here is a third alternative, I&rsquo;ve <a href="/simplest-way-to-speed-up-rspec-with-in-memory-sqlite-db/">already written about it</a>, but here it comes updated and tested for Rails 5 :</p>

<ol>
<li>Don&rsquo;t change anything to your <code>config/database.yml</code></li>
<li>Obviously, you&rsquo;ll need to add <code>sqlite3</code> to your <code>Gemfile</code></li>
<li>At the beginning of your <code>spec/rails_helper.rb</code>, replace</li>
</ol>


<p>``` ruby</p>

<h1>Checks for pending migration and applies them before tests are run.</h1>

<h1>If you are not using ActiveRecord, you can remove this line.</h1>

<p>ActiveRecord::Migration.maintain_test_schema!
```</p>

<p>with</p>

<p>``` ruby</p>

<h1>In order to keep the same RAILS_ENV for rspec and cucumber, and to make rspec</h1>

<h1>faster, patch the connection to use sqlite in memory when running rspec</h1>

<p>ActiveRecord::Base.establish_connection(adapter: &lsquo;sqlite3&rsquo;, database: &lsquo;:memory:&rsquo;)
ActiveRecord::Schema.verbose = false
load &ldquo;#{Rails.root.to_s}/db/schema.rb&rdquo;
```</p>

<p>That&rsquo;s it ! Run your specs &hellip; not bad for a 5 minutes investment !</p>

<h4>Rails 5.1 (2017-03-29 Edit)</h4>

<p>My fresh hack started to fail on Rails 5.1 ! If <code>schema.rb</code> is generated with the Postgres adapter, it is now incompatible with this injected Sqlite adapter. Here is a patch that removes the glitches :</p>

<p>```ruby</p>

<h1>In order to keep the same RAILS_ENV for rspec and cucumber, and to make rspec</h1>

<h1>faster, patch the connection to use sqlite in memory when running rspec</h1>

<p>ActiveRecord::Base.establish_connection(adapter: &lsquo;sqlite3&rsquo;, database: &lsquo;:memory:&rsquo;)
ActiveRecord::Schema.verbose = false</p>

<h1>load db agnostic schema by default. Needed to remove the &ldquo;, id: :serial&rdquo; from</h1>

<h1>the table definitions to make it load on sqlite</h1>

<p>eval(<code>cat #{Rails.root.to_s}/db/schema.rb | sed 's/,[^:]*: :serial\//g'</code>)
```</p>

<p>I admit this is getting a bit crappy, and I don&rsquo;t know how long it is going to work &hellip;</p>

<h2>One more thing &hellip;</h2>

<p>If you need even more speed, you can now run your specs in parallel in different processes ! Each in-memory SQLite DB is bound to its process, so unlike a real PostgreSQL dev DB, you won&rsquo;t get any conflicts between your tests ;&ndash;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Continuously Deliver a Rails App to your DigitalOcean Box using Docker]]></title>
    <link href="http://philippe.bourgau.net/continuously-deliver-a-rails-app-to-your-digital-ocean-box-using-docker/"/>
    <updated>2016-10-25T20:39:00+02:00</updated>
    <id>http://philippe.bourgau.net/continuously-deliver-a-rails-app-to-your-digital-ocean-box-using-docker</id>
    <content type="html"><![CDATA[<p>I decided to use <a href="https://github.com/philou/planning-poker">my latest side project</a> as an occasion to learn <a href="https://www.docker.com/">Docker</a>. I first used <a href="https://www.heroku.com/">Heroku</a> as a platform for deployment (see <a href="/how-to-boot-a-new-rails-project-with-docker-and-heroku/">previous post</a>). It works fine but I discovered the following shortcomings :</p>

<ul>
<li>Heroku does not deploy with Docker, which means that I&rsquo;d get quite different configurations between dev and prod, which is one of the promises of Docker :(</li>
<li>The dockerfile provided by docker runs bundle install in a directory outside of the docker main shared volume, this forces to do bundle update twice (once to update Gemfile.lock and a second time to update the actual gems &hellip;)</li>
</ul>


<p>None of these issues could be fixed without moving away from Heroku.</p>

<h2>A great Tutorial / Guide</h2>

<p>I followed <a href="http://chrisstump.online/">Chris Stump</a>&rsquo;s great tutorials to <a href="http://chrisstump.online/2016/02/20/docker-existing-rails-application/">setup Docker for my app</a>, to <a href="http://chrisstump.online/2016/03/03/continuous-integration-docker-rails/">continuously integrate</a> on <a href="https://circleci.com/">CircleCI</a> and to <a href="http://chrisstump.online/2016/03/17/continuous-deployment-docker-rails/">continuously deploy</a> on a private virtual server on <a href="https://www.digitalocean.com/">DigitalOcean</a>.</p>

<p>The first 2 steps (Docker &amp; CI) worked really out of the box after following the tutorial. Dealing with step 3 (CD) was a bit more complicated, because of :</p>

<ol>
<li>the specificities of DigitalOcean</li>
<li>the fact that I&rsquo;m a no deployment expert &hellip;</li>
</ol>


<p><img class="center" src="/imgs/2016-10-25-continuously-deliver-a-rails-app-to-your-digital-ocean-box-using-docker/docker-circleci-digitalocean.jpg" title="The logos of Docker, CircleCI and DigitalOcean" ></p>

<h2>What did I need to do to make it work</h2>

<h3>Setup SSH on the DigitalOcean box</h3>

<p>I started by creating a <a href="https://cloud.digitalocean.com/droplets/new?size=2gb&amp;region=nyc3&amp;appId=20423249&amp;type=applications">one-click DigitalOcean box</a> with Docker pre-installed. That&rsquo;s the moment where I had to setup SSH in order to make CircleCI deploy to my box. DigitalOcean has a <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ssh-keys-with-digitalocean-droplets">guide for this</a>, but here is how I did it :</p>

<ol>
<li>Create a special user on my dev machine <code>adduser digitaloceanssh</code></li>
<li>Log as this user <code>su digitaloceanssh</code>, and generated ssh keys for it <code>ssh-keygen</code></li>
<li>Print the public key <code>cat ~/.ssh/id_rsa.pub</code> and copy paste it in your DigitalOcean box setup</li>
<li>Print the private key <code>cat ~/.ssh/id_rsa</code> and copy past it in your circle-ci job ssh keys</li>
</ol>


<p>The benefit of this is that you should now be able to ssh in your DigitalOcean box from your digitaloceanssh user <code>ssh root@&lt;ip.to.digital.ocean&gt;</code></p>

<h3>Optional : update the box</h3>

<p>The first time I logged into my box, I noted that packages were out of date. If you need it, updating the packages is a simple matter of <code>apt-get update &amp;&amp; apt-get upgrade</code></p>

<h3>Fix deployment directory</h3>

<p>By default, the home dir of the root user on the DigitalOcean box is <code>/root/</code>. Unfortunately, Chris Stump&rsquo;s tutorial assumes it to be <code>/home/root/</code>. In order to fix that, I ssh-ed in the box and created a symbolic link : <code>ln -s /root /home/root</code>.</p>

<h3>Install docker-compose on the box</h3>

<p>Chris Stump&rsquo;s tutorial expects docker-compose on the deployment box, but DigitalOcean only installs Docker on its boxes &hellip; Install instructions for docker-compose can be found <a href="https://docs.docker.com/compose/install/">here</a>. Don&rsquo;t use the container option, it does not inherit environment variables, and will fail the deployment, just use the first curl based alternative.</p>

<h3>Warning : replace ALL dockerexample</h3>

<p>This comes as an evidence, but be sure to replace all the references to &lsquo;dockerexample&rsquo; to your own app name in all of Chris Stump&rsquo;s templates (I forgot some and lost a few rebuilds for that)</p>

<h3>Create the production DB</h3>

<p>Chris Stump&rsquo;s deployment script works with an existing production DB. The first migration will fail. To fix this, just do the following :</p>

<ol>
<li>ssh into the DigitalOcean server</li>
<li>run <code>DEPLOY_TAG=&lt;latest_deploy_tag&gt; RAILS_ENV=production docker-compose -f docker-compose.production.yml run app bundle exec rake db:create</code></li>
</ol>


<p>You can find the latest DEPLOY_TAG from the CircleCi step <code>bundle exec rake docker:deploy</code></p>

<h3>How to access the logs</h3>

<p>It might come handy to check the logs of your production server ! Here is how to do this :</p>

<ol>
<li>ssh in your production server</li>
<li>run the following to tail on the logs <code>DEPLOY_TAG=`cat deploy.tag` RAILS_ENV=production docker-compose -f docker-compose.production.yml run app tail -f log/production.log</code></li>
</ol>


<p>Obviously, tail is just an example, use anything else at your convenience.</p>

<h3>Generate a secret token</h3>

<p>Eventually, the build and deployment job succeeded &hellip; I had still one last error when I tried to access the web site : <code>An unhandled lowlevel error occurred. The application logs may have details.</code>. After some googling, I understood that this error occurs when you did not set a secret key base for your rails app (<a href="http://stackoverflow.com/questions/37112804/an-unhandled-lowlevel-error-occurred-the-application-logs-may-have-details">details</a>). There is a <a href="http://www.jamesbadger.ca/2012/12/18/generate-new-secret-token/">rails task to generate a token</a>, all that was needed was to create a .env file on the server with the following :</p>

<p><code>SECRET_KEY_BASE=&lt;GENERATED_SECRET...&gt;</code></p>

<h2>What&rsquo;s next ?</h2>

<p>Obviously, I learned quite a lot with this Docker exploration. I am still in the discovery phase, but my planning poker side project is now continuously built on <a href="https://circleci.com/gh/philou/planning-poker">circleci</a>, and deployed to a <a href="http://104.131.47.10/">DigitalOcean box</a>.</p>

<p>The next steps (first, find a better subdomain, second, speed up the build job) will tell me if this kind of deployment is what I need for my pet projects. If it turns out too complicated or too difficult to maintain, <a href="http://dokku.viewdocs.io/dokku/">Dokku</a> is on my radar.</p>
]]></content>
  </entry>
  
</feed>
